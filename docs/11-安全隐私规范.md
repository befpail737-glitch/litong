# 安全隐私规范

## 数据安全策略

### 用户数据分类
```typescript
// 数据分类和处理规范
interface DataClassification {
  public: {
    description: '公开可访问的数据';
    examples: ['产品信息', '技术文章', '公司介绍'];
    encryption: false;
    retention: 'permanent';
  };
  
  internal: {
    description: '内部业务数据';
    examples: ['询价记录', '用户行为分析', '业务统计'];
    encryption: true;
    retention: '2 years';
  };
  
  confidential: {
    description: '机密业务数据';
    examples: ['客户联系信息', '价格策略', '供应商信息'];
    encryption: true;
    retention: '7 years';
  };
  
  restricted: {
    description: '受限访问数据';
    examples: ['系统密钥', '第三方API密钥', '管理员凭证'];
    encryption: true;
    retention: 'until_replaced';
  };
}
```

### 数据收集规范
```typescript
// src/lib/privacy/data-collection.ts
interface DataCollectionConsent {
  necessary: {
    description: '网站正常运行必需的数据';
    items: [
      '页面访问日志',
      '会话标识符',
      '安全验证数据'
    ];
    consent_required: false;
    legal_basis: 'legitimate_interest';
  };
  
  functional: {
    description: '提升用户体验的功能性数据';
    items: [
      '语言偏好设置',
      '产品收藏记录',
      '搜索历史记录'
    ];
    consent_required: true;
    legal_basis: 'consent';
  };
  
  analytics: {
    description: '网站分析和改进数据';
    items: [
      'Google Analytics数据',
      '页面性能指标',
      '用户行为统计'
    ];
    consent_required: true;
    legal_basis: 'consent';
  };
  
  marketing: {
    description: '营销和推广相关数据';
    items: [
      '询价联系信息',
      '邮件订阅记录',
      '营销活动跟踪'
    ];
    consent_required: true;
    legal_basis: 'consent';
  };
}
```

## 隐私合规设计

### Cookie策略实现
```typescript
// src/components/common/CookieConsent/CookieConsent.tsx
'use client';

interface CookiePreferences {
  necessary: true; // 始终为true
  functional: boolean;
  analytics: boolean;
  marketing: boolean;
}

export function CookieConsent() {
  const [showBanner, setShowBanner] = useState(false);
  const [showDetails, setShowDetails] = useState(false);
  const [preferences, setPreferences] = useState<CookiePreferences>({
    necessary: true,
    functional: false,
    analytics: false,
    marketing: false,
  });

  const handleAcceptAll = () => {
    const allAccepted = {
      necessary: true,
      functional: true,
      analytics: true,
      marketing: true,
    };
    saveCookiePreferences(allAccepted);
    initializeServices(allAccepted);
    setShowBanner(false);
  };

  const handleRejectAll = () => {
    const onlyNecessary = {
      necessary: true,
      functional: false,
      analytics: false,
      marketing: false,
    };
    saveCookiePreferences(onlyNecessary);
    setShowBanner(false);
  };

  const handleSavePreferences = () => {
    saveCookiePreferences(preferences);
    initializeServices(preferences);
    setShowBanner(false);
  };

  if (!showBanner) return null;

  return (
    <div className="fixed bottom-0 left-0 right-0 bg-white border-t shadow-lg z-50">
      <div className="container mx-auto px-4 py-6">
        {!showDetails ? (
          // 简化横幅
          <div className="flex flex-col md:flex-row items-center justify-between gap-4">
            <div className="flex-1">
              <p className="text-sm text-gray-600">
                我们使用Cookie来改善您的浏览体验。继续使用本网站即表示您同意我们的
                <a href="/privacy-policy" className="text-primary-600 underline">
                  隐私政策
                </a>
                。
              </p>
            </div>
            <div className="flex gap-3">
              <button
                onClick={() => setShowDetails(true)}
                className="btn btn-secondary btn-sm"
              >
                管理偏好
              </button>
              <button
                onClick={handleRejectAll}
                className="btn btn-secondary btn-sm"
              >
                仅必要
              </button>
              <button
                onClick={handleAcceptAll}
                className="btn btn-primary btn-sm"
              >
                全部接受
              </button>
            </div>
          </div>
        ) : (
          // 详细设置
          <div className="max-w-2xl mx-auto">
            <h3 className="text-lg font-semibold mb-4">Cookie偏好设置</h3>
            
            <div className="space-y-4">
              <CookieCategory
                title="必要Cookie"
                description="这些Cookie是网站正常运行所必需的，无法禁用。"
                enabled={true}
                disabled={true}
              />
              
              <CookieCategory
                title="功能性Cookie"
                description="这些Cookie用于记住您的偏好设置，提供个性化体验。"
                enabled={preferences.functional}
                onChange={(enabled) => 
                  setPreferences(prev => ({ ...prev, functional: enabled }))
                }
              />
              
              <CookieCategory
                title="分析Cookie"
                description="这些Cookie帮助我们了解网站使用情况，改善用户体验。"
                enabled={preferences.analytics}
                onChange={(enabled) => 
                  setPreferences(prev => ({ ...prev, analytics: enabled }))
                }
              />
              
              <CookieCategory
                title="营销Cookie"
                description="这些Cookie用于投放相关广告，跟踪营销活动效果。"
                enabled={preferences.marketing}
                onChange={(enabled) => 
                  setPreferences(prev => ({ ...prev, marketing: enabled }))
                }
              />
            </div>
            
            <div className="flex justify-between mt-6">
              <button
                onClick={() => setShowDetails(false)}
                className="btn btn-secondary"
              >
                返回
              </button>
              <div className="flex gap-3">
                <button
                  onClick={handleRejectAll}
                  className="btn btn-secondary"
                >
                  拒绝全部
                </button>
                <button
                  onClick={handleSavePreferences}
                  className="btn btn-primary"
                >
                  保存设置
                </button>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
```

### 隐私政策页面
```html
<!-- 隐私政策页面内容结构 -->
<div class="privacy-policy">
  <h1>隐私政策</h1>
  
  <section class="policy-section">
    <h2>1. 信息收集</h2>
    <h3>1.1 自动收集的信息</h3>
    <ul>
      <li>访问日志和IP地址</li>
      <li>浏览器类型和版本</li>
      <li>操作系统信息</li>
      <li>访问时间和页面</li>
    </ul>
    
    <h3>1.2 主动提供的信息</h3>
    <ul>
      <li>询价表单中的联系信息</li>
      <li>订阅邮件的邮箱地址</li>
      <li>客户服务沟通记录</li>
    </ul>
  </section>
  
  <section class="policy-section">
    <h2>2. 信息使用</h2>
    <ul>
      <li>提供产品信息和技术支持</li>
      <li>处理询价请求和业务咨询</li>
      <li>发送产品更新和行业资讯</li>
      <li>改善网站功能和用户体验</li>
      <li>合法合规的业务运营需要</li>
    </ul>
  </section>
  
  <section class="policy-section">
    <h2>3. 信息分享</h2>
    <p>我们不会向第三方出售、交易或转让您的个人信息，除非：</p>
    <ul>
      <li>获得您的明确同意</li>
      <li>法律法规要求披露</li>
      <li>为提供服务而必需的合作伙伴</li>
      <li>保护我们的合法权益</li>
    </ul>
  </section>
  
  <section class="policy-section">
    <h2>4. 信息安全</h2>
    <ul>
      <li>采用行业标准的加密技术</li>
      <li>定期进行安全评估和更新</li>
      <li>限制员工对个人信息的访问</li>
      <li>建立数据泄露应急响应机制</li>
    </ul>
  </section>
  
  <section class="policy-section">
    <h2>5. 您的权利</h2>
    <ul>
      <li>访问权：查看我们持有的您的信息</li>
      <li>更正权：要求更正不准确的信息</li>
      <li>删除权：要求删除您的个人信息</li>
      <li>限制权：限制对您信息的处理</li>
      <li>反对权：反对某些处理方式</li>
      <li>数据可携权：获取您的数据副本</li>
    </ul>
  </section>
  
  <section class="policy-section">
    <h2>6. Cookie使用</h2>
    <p>我们使用Cookie和类似技术来：</p>
    <ul>
      <li>确保网站正常运行</li>
      <li>记住您的偏好设置</li>
      <li>分析网站使用情况</li>
      <li>提供个性化服务</li>
    </ul>
    <p>您可以通过浏览器设置管理Cookie偏好。</p>
  </section>
  
  <section class="policy-section">
    <h2>7. 联系我们</h2>
    <p>如有隐私相关问题，请联系我们：</p>
    <ul>
      <li>邮箱：privacy@elec-distributor.com</li>
      <li>电话：+86-xxx-xxxx-xxxx</li>
      <li>地址：[公司地址]</li>
    </ul>
  </section>
  
  <footer class="policy-footer">
    <p>本隐私政策最后更新：2024年1月1日</p>
    <p>我们保留随时修改本政策的权利，重大变更将通过网站通知。</p>
  </footer>
</div>
```

## 表单安全设计

### 询价表单验证
```typescript
// src/lib/security/form-validation.ts
import { z } from 'zod';

export const InquiryFormSchema = z.object({
  // 基础验证
  productId: z.string().min(1, '产品ID不能为空'),
  quantity: z.number().min(1, '数量必须大于0').max(1000000, '数量不能超过100万'),
  
  // 联系信息验证
  contactName: z
    .string()
    .min(2, '姓名至少2个字符')
    .max(50, '姓名不能超过50个字符')
    .regex(/^[\u4e00-\u9fa5a-zA-Z\s]+$/, '姓名只能包含中文、英文和空格'),
    
  phone: z
    .string()
    .regex(/^1[3-9]\d{9}$|^\+\d{1,3}\d{6,14}$/, '请输入有效的手机号码'),
    
  email: z
    .string()
    .email('请输入有效的邮箱地址')
    .max(100, '邮箱地址不能超过100个字符'),
    
  company: z
    .string()
    .max(100, '公司名称不能超过100个字符')
    .optional(),
    
  // 内容验证
  application: z
    .string()
    .max(500, '应用场景描述不能超过500个字符')
    .optional(),
    
  remarks: z
    .string()
    .max(300, '备注信息不能超过300个字符')
    .optional(),
    
  // 安全验证
  captcha: z.string().min(1, '请完成验证码验证'),
  
  // 同意条款
  agreeToTerms: z.boolean().refine(val => val === true, {
    message: '请阅读并同意服务条款',
  }),
  
  agreeToPrivacy: z.boolean().refine(val => val === true, {
    message: '请阅读并同意隐私政策',
  }),
});

// 服务端验证中间件
export async function validateInquiryForm(formData: unknown) {
  try {
    const validatedData = InquiryFormSchema.parse(formData);
    
    // 额外安全检查
    await Promise.all([
      checkRateLimit(validatedData.email),
      validateCaptcha(validatedData.captcha),
      scanForMaliciousContent(validatedData),
    ]);
    
    return { success: true, data: validatedData };
  } catch (error) {
    return { 
      success: false, 
      errors: error instanceof z.ZodError ? error.errors : ['验证失败'] 
    };
  }
}

// 内容安全扫描
async function scanForMaliciousContent(data: any): Promise<void> {
  const suspiciousPatterns = [
    /<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi,
    /javascript:/gi,
    /data:text\/html/gi,
    /vbscript:/gi,
  ];
  
  const textFields = [data.application, data.remarks, data.contactName];
  
  for (const field of textFields) {
    if (!field) continue;
    
    for (const pattern of suspiciousPatterns) {
      if (pattern.test(field)) {
        throw new Error('检测到可疑内容，请重新输入');
      }
    }
  }
}
```

### CSRF保护
```typescript
// src/lib/security/csrf.ts
import { cookies } from 'next/headers';
import { randomBytes, createHash } from 'crypto';

export function generateCSRFToken(): string {
  const token = randomBytes(32).toString('hex');
  const hash = createHash('sha256').update(token).digest('hex');
  
  // 在服务端设置Cookie
  cookies().set('csrf-token', hash, {
    httpOnly: true,
    secure: process.env.NODE_ENV === 'production',
    sameSite: 'strict',
    maxAge: 3600, // 1小时
  });
  
  return token;
}

export function validateCSRFToken(token: string): boolean {
  const cookieToken = cookies().get('csrf-token')?.value;
  if (!cookieToken || !token) return false;
  
  const hash = createHash('sha256').update(token).digest('hex');
  return hash === cookieToken;
}

// 表单组件中使用
export function SecureForm({ children }: { children: React.ReactNode }) {
  const csrfToken = generateCSRFToken();
  
  return (
    <form>
      <input type="hidden" name="csrf_token" value={csrfToken} />
      {children}
    </form>
  );
}
```

## API安全规范

### 请求频率限制
```typescript
// src/lib/security/rate-limit.ts
interface RateLimitConfig {
  windowMs: number;    // 时间窗口（毫秒）
  maxRequests: number; // 最大请求数
  skipSuccessfulRequests?: boolean;
  skipFailedRequests?: boolean;
}

const rateLimitConfigs: Record<string, RateLimitConfig> = {
  // 询价表单：每小时最多5次
  inquiry: {
    windowMs: 60 * 60 * 1000,
    maxRequests: 5,
  },
  
  // 搜索API：每分钟最多60次
  search: {
    windowMs: 60 * 1000,
    maxRequests: 60,
  },
  
  // 下载API：每小时最多100次
  download: {
    windowMs: 60 * 60 * 1000,
    maxRequests: 100,
  },
  
  // 通用API：每分钟最多30次
  general: {
    windowMs: 60 * 1000,
    maxRequests: 30,
  },
};

export class RateLimit {
  private store = new Map<string, { count: number; resetTime: number }>();
  
  async isAllowed(
    identifier: string, 
    endpoint: keyof typeof rateLimitConfigs
  ): Promise<{ allowed: boolean; remainingRequests?: number; resetTime?: number }> {
    const config = rateLimitConfigs[endpoint];
    const key = `${endpoint}:${identifier}`;
    const now = Date.now();
    
    let record = this.store.get(key);
    
    // 重置过期的记录
    if (!record || now > record.resetTime) {
      record = {
        count: 0,
        resetTime: now + config.windowMs,
      };
      this.store.set(key, record);
    }
    
    // 检查是否超出限制
    if (record.count >= config.maxRequests) {
      return {
        allowed: false,
        remainingRequests: 0,
        resetTime: record.resetTime,
      };
    }
    
    // 增加请求计数
    record.count += 1;
    
    return {
      allowed: true,
      remainingRequests: config.maxRequests - record.count,
      resetTime: record.resetTime,
    };
  }
}

export const rateLimit = new RateLimit();
```

### API密钥管理
```typescript
// src/lib/security/api-keys.ts
interface APIKeyConfig {
  name: string;
  environment: 'development' | 'production';
  permissions: string[];
  rateLimit: number;
  expiresAt?: Date;
}

export class APIKeyManager {
  private keys = new Map<string, APIKeyConfig>();
  
  generateKey(config: Omit<APIKeyConfig, 'name'>): string {
    const keyId = randomBytes(16).toString('hex');
    const keySecret = randomBytes(32).toString('hex');
    const apiKey = `ltc_${keyId}_${keySecret}`;
    
    this.keys.set(apiKey, {
      ...config,
      name: keyId,
    });
    
    return apiKey;
  }
  
  validateKey(apiKey: string, requiredPermission?: string): boolean {
    const config = this.keys.get(apiKey);
    if (!config) return false;
    
    // 检查过期时间
    if (config.expiresAt && config.expiresAt < new Date()) {
      return false;
    }
    
    // 检查权限
    if (requiredPermission && !config.permissions.includes(requiredPermission)) {
      return false;
    }
    
    return true;
  }
  
  revokeKey(apiKey: string): boolean {
    return this.keys.delete(apiKey);
  }
}
```

## 内容安全策略

### CSP Header配置
```typescript
// src/lib/security/csp.ts
export function generateCSPHeader(): string {
  const csp = {
    'default-src': ["'self'"],
    'script-src': [
      "'self'",
      "'unsafe-inline'", // Needed for Next.js
      "'unsafe-eval'",   // Needed for development
      'https://www.googletagmanager.com',
      'https://www.google-analytics.com',
      'https://cdn.sanity.io',
    ],
    'style-src': [
      "'self'",
      "'unsafe-inline'", // Needed for styled-components
      'https://fonts.googleapis.com',
    ],
    'font-src': [
      "'self'",
      'https://fonts.gstatic.com',
    ],
    'img-src': [
      "'self'",
      'data:',
      'https://cdn.sanity.io',
      'https://images.unsplash.com',
      'https://www.google-analytics.com',
    ],
    'connect-src': [
      "'self'",
      'https://api.sanity.io',
      'https://oquvb2bs.api.sanity.io',
      'https://www.google-analytics.com',
      'https://analytics.google.com',
    ],
    'frame-src': [
      "'none'",
    ],
    'object-src': [
      "'none'",
    ],
    'base-uri': [
      "'self'",
    ],
    'form-action': [
      "'self'",
    ],
    'frame-ancestors': [
      "'none'",
    ],
  };
  
  return Object.entries(csp)
    .map(([directive, sources]) => `${directive} ${sources.join(' ')}`)
    .join('; ');
}

// Next.js headers配置
export const securityHeaders = [
  {
    key: 'Content-Security-Policy',
    value: generateCSPHeader(),
  },
  {
    key: 'X-Frame-Options',
    value: 'DENY',
  },
  {
    key: 'X-Content-Type-Options',
    value: 'nosniff',
  },
  {
    key: 'Referrer-Policy',
    value: 'strict-origin-when-cross-origin',
  },
  {
    key: 'Permissions-Policy',
    value: 'camera=(), microphone=(), geolocation=(), interest-cohort=()',
  },
];
```

### 输入输出清理
```typescript
// src/lib/security/sanitizer.ts
import DOMPurify from 'dompurify';
import { JSDOM } from 'jsdom';

// 服务端HTML清理
const window = new JSDOM('').window;
const purify = DOMPurify(window as any);

export function sanitizeHTML(dirty: string): string {
  return purify.sanitize(dirty, {
    ALLOWED_TAGS: [
      'p', 'br', 'strong', 'em', 'u', 'ol', 'ul', 'li',
      'h1', 'h2', 'h3', 'h4', 'h5', 'h6',
      'blockquote', 'code', 'pre',
      'a', 'img',
    ],
    ALLOWED_ATTR: [
      'href', 'target', 'rel',
      'src', 'alt', 'width', 'height',
    ],
    ALLOWED_URI_REGEXP: /^(?:(?:(?:f|ht)tps?|mailto|tel|callto|sms|cid|xmpp):|[^a-z]|[a-z+.\-]+(?:[^a-z+.\-:]|$))/i,
  });
}

export function sanitizeText(text: string): string {
  return text
    .replace(/[<>]/g, '') // 移除尖括号
    .replace(/javascript:/gi, '') // 移除javascript协议
    .replace(/on\w+=/gi, '') // 移除事件处理器
    .trim();
}

// 文件名安全化
export function sanitizeFileName(fileName: string): string {
  return fileName
    .replace(/[^a-zA-Z0-9._-]/g, '_') // 只允许安全字符
    .replace(/^\.+/, '') // 移除开头的点
    .substring(0, 255); // 限制长度
}
```

## 数据备份安全

### 敏感数据处理
```typescript
// src/lib/security/data-protection.ts
import { createCipher, createDecipher, randomBytes } from 'crypto';

export class DataProtection {
  private encryptionKey: string;
  
  constructor() {
    this.encryptionKey = process.env.ENCRYPTION_KEY || this.generateKey();
  }
  
  // 加密敏感数据
  encrypt(data: string): { encrypted: string; iv: string } {
    const iv = randomBytes(16);
    const cipher = createCipher('aes-256-cbc', this.encryptionKey);
    cipher.setIVMode(iv);
    
    let encrypted = cipher.update(data, 'utf8', 'hex');
    encrypted += cipher.final('hex');
    
    return {
      encrypted,
      iv: iv.toString('hex'),
    };
  }
  
  // 解密数据
  decrypt(encrypted: string, iv: string): string {
    const decipher = createDecipher('aes-256-cbc', this.encryptionKey);
    decipher.setIVMode(Buffer.from(iv, 'hex'));
    
    let decrypted = decipher.update(encrypted, 'hex', 'utf8');
    decrypted += decipher.final('utf8');
    
    return decrypted;
  }
  
  // 生成加密密钥
  private generateKey(): string {
    return randomBytes(32).toString('hex');
  }
  
  // 数据脱敏
  maskSensitiveData(data: any): any {
    const masked = { ...data };
    
    // 脱敏邮箱
    if (masked.email) {
      const [local, domain] = masked.email.split('@');
      masked.email = `${local.substring(0, 2)}***@${domain}`;
    }
    
    // 脱敏手机号
    if (masked.phone) {
      masked.phone = masked.phone.replace(/(\d{3})\d{4}(\d{4})/, '$1****$2');
    }
    
    // 脱敏地址
    if (masked.address) {
      masked.address = masked.address.replace(/详细地址.*/, '***');
    }
    
    return masked;
  }
}

export const dataProtection = new DataProtection();
```

### 审计日志系统
```typescript
// src/lib/security/audit-log.ts
interface AuditLogEntry {
  id: string;
  timestamp: Date;
  userId?: string;
  sessionId?: string;
  action: string;
  resource: string;
  details: Record<string, any>;
  ipAddress: string;
  userAgent: string;
  success: boolean;
  errorMessage?: string;
}

export class AuditLogger {
  private logs: AuditLogEntry[] = [];
  
  log(entry: Omit<AuditLogEntry, 'id' | 'timestamp'>): void {
    const logEntry: AuditLogEntry = {
      id: randomBytes(16).toString('hex'),
      timestamp: new Date(),
      ...entry,
    };
    
    this.logs.push(logEntry);
    
    // 在生产环境中，发送到日志服务
    if (process.env.NODE_ENV === 'production') {
      this.sendToLogService(logEntry);
    }
  }
  
  // 记录用户操作
  logUserAction(
    action: string,
    resource: string,
    userId?: string,
    details?: Record<string, any>
  ): void {
    this.log({
      userId,
      sessionId: this.getSessionId(),
      action,
      resource,
      details: details || {},
      ipAddress: this.getClientIP(),
      userAgent: this.getUserAgent(),
      success: true,
    });
  }
  
  // 记录安全事件
  logSecurityEvent(
    event: string,
    severity: 'low' | 'medium' | 'high' | 'critical',
    details: Record<string, any>
  ): void {
    this.log({
      action: 'security_event',
      resource: event,
      details: { severity, ...details },
      ipAddress: this.getClientIP(),
      userAgent: this.getUserAgent(),
      success: false,
    });
    
    // 高严重性事件立即通知
    if (['high', 'critical'].includes(severity)) {
      this.sendSecurityAlert(event, severity, details);
    }
  }
  
  private async sendToLogService(entry: AuditLogEntry): Promise<void> {
    try {
      await fetch('/api/audit-logs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entry),
      });
    } catch (error) {
      console.error('Failed to send audit log:', error);
    }
  }
  
  private async sendSecurityAlert(
    event: string,
    severity: string,
    details: Record<string, any>
  ): Promise<void> {
    // 发送安全告警邮件或钉钉通知
    try {
      await fetch('/api/security-alerts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ event, severity, details }),
      });
    } catch (error) {
      console.error('Failed to send security alert:', error);
    }
  }
  
  private getSessionId(): string {
    // 从请求中获取会话ID
    return 'session-id';
  }
  
  private getClientIP(): string {
    // 从请求中获取客户端IP
    return '127.0.0.1';
  }
  
  private getUserAgent(): string {
    // 从请求头获取User-Agent
    return 'unknown';
  }
}

export const auditLogger = new AuditLogger();
```