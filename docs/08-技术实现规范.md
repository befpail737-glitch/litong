# 技术实现规范

## Next.js项目结构设计

### 项目目录结构
```
litong/
├── .env.local                    # 环境变量配置
├── .env.example                  # 环境变量示例
├── .gitignore                    # Git忽略文件
├── README.md                     # 项目文档
├── package.json                  # 项目依赖
├── tailwind.config.js            # Tailwind配置
├── tsconfig.json                 # TypeScript配置
├── next.config.js                # Next.js配置
├── sanity.config.ts              # Sanity配置
├── sanity.cli.ts                 # Sanity CLI配置
│
├── public/                       # 静态资源
│   ├── images/                   # 图片资源
│   │   ├── brands/               # 品牌Logo
│   │   ├── products/             # 产品图片
│   │   ├── icons/                # SVG图标
│   │   ├── banners/              # 横幅图片
│   │   └── backgrounds/          # 背景图片
│   ├── documents/                # 文档资源
│   │   ├── datasheets/           # 产品规格书
│   │   ├── certificates/         # 认证证书
│   │   └── guides/               # 选型指南
│   ├── favicon.ico               # 网站图标
│   ├── robots.txt                # 搜索引擎配置
│   └── sitemap.xml               # 网站地图
│
├── src/                          # 源代码目录
│   ├── app/                      # Next.js App Router
│   │   ├── globals.css           # 全局样式
│   │   ├── layout.tsx            # 全局布局
│   │   ├── loading.tsx           # 全局加载页
│   │   ├── error.tsx             # 全局错误页
│   │   ├── not-found.tsx         # 404页面
│   │   ├── page.tsx              # 首页
│   │   │
│   │   ├── brands/               # 品牌相关页面
│   │   │   ├── page.tsx          # 品牌列表页
│   │   │   ├── loading.tsx       # 品牌页加载态
│   │   │   └── [slug]/           # 品牌中心页
│   │   │       ├── layout.tsx    # 品牌布局
│   │   │       ├── page.tsx      # 品牌首页
│   │   │       ├── about/        # 关于品牌
│   │   │       ├── categories/   # 产品分类
│   │   │       ├── solutions/    # 解决方案
│   │   │       ├── support/      # 技术支持
│   │   │       └── news/         # 新闻中心
│   │   │
│   │   ├── products/             # 产品相关页面
│   │   │   ├── page.tsx          # 产品首页
│   │   │   └── [...slug]/        # 动态产品路由
│   │   │       └── page.tsx      # 产品详情页
│   │   │
│   │   ├── about/                # 关于我们
│   │   │   ├── page.tsx          # 关于首页
│   │   │   └── [slug]/           # 子页面
│   │   │
│   │   ├── search/               # 搜索页面
│   │   │   └── page.tsx          # 搜索结果页
│   │   │
│   │   ├── inquiry/              # 询价相关
│   │   │   ├── single/           # 单产品询价
│   │   │   └── bulk/             # 批量询价
│   │   │
│   │   └── [locale]/             # 多语言版本
│   │       └── ...               # 复制上述结构
│   │
│   ├── components/               # React组件
│   │   ├── ui/                   # 基础UI组件
│   │   │   ├── Button/           # 按钮组件
│   │   │   ├── Input/            # 输入框组件
│   │   │   ├── Card/             # 卡片组件
│   │   │   ├── Modal/            # 弹窗组件
│   │   │   └── Loading/          # 加载组件
│   │   │
│   │   ├── layout/               # 布局组件
│   │   │   ├── Header/           # 页头组件
│   │   │   ├── Footer/           # 页脚组件
│   │   │   ├── Navigation/       # 导航组件
│   │   │   └── Sidebar/          # 侧边栏组件
│   │   │
│   │   ├── features/             # 功能组件
│   │   │   ├── ProductCard/      # 产品卡片
│   │   │   ├── SearchBar/        # 搜索栏
│   │   │   ├── ProductFilter/    # 产品筛选
│   │   │   ├── InquiryForm/      # 询价表单
│   │   │   └── BrandCard/        # 品牌卡片
│   │   │
│   │   └── common/               # 通用组件
│   │       ├── SEO/              # SEO组件
│   │       ├── Breadcrumb/       # 面包屑
│   │       ├── Pagination/       # 分页组件
│   │       └── LanguageSwitch/   # 语言切换
│   │
│   ├── lib/                      # 工具库
│   │   ├── sanity/               # Sanity相关
│   │   │   ├── client.ts         # Sanity客户端
│   │   │   ├── queries.ts        # GROQ查询
│   │   │   └── schemas/          # 数据模型
│   │   ├── utils/                # 工具函数
│   │   │   ├── format.ts         # 格式化函数
│   │   │   ├── validation.ts     # 验证函数
│   │   │   └── constants.ts      # 常量定义
│   │   ├── hooks/                # 自定义Hooks
│   │   │   ├── useSearch.ts      # 搜索Hook
│   │   │   ├── useProducts.ts    # 产品Hook
│   │   │   └── useInquiry.ts     # 询价Hook
│   │   └── api/                  # API相关
│   │       ├── products.ts       # 产品API
│   │       ├── brands.ts         # 品牌API
│   │       └── inquiry.ts        # 询价API
│   │
│   ├── styles/                   # 样式文件
│   │   ├── globals.css           # 全局样式
│   │   ├── components.css        # 组件样式
│   │   └── utilities.css         # 工具样式
│   │
│   ├── types/                    # TypeScript类型定义
│   │   ├── sanity.ts             # Sanity数据类型
│   │   ├── product.ts            # 产品类型
│   │   ├── brand.ts              # 品牌类型
│   │   └── common.ts             # 通用类型
│   │
│   └── i18n/                     # 国际化
│       ├── locales/              # 语言包
│       │   ├── zh.json           # 中文
│       │   ├── en.json           # 英文
│       │   └── ...               # 其他语言
│       ├── config.ts             # i18n配置
│       └── server.ts             # 服务端i18n
│
├── sanity/                       # Sanity Studio配置
│   ├── schemas/                  # 数据模型定义
│   │   ├── brand.ts              # 品牌模型
│   │   ├── product.ts            # 产品模型
│   │   ├── article.ts            # 文章模型
│   │   ├── author.ts             # 作者模型
│   │   └── index.ts              # 导出文件
│   ├── structure/                # Studio结构
│   │   └── index.ts              # 结构定义
│   └── plugins/                  # 自定义插件
│       └── customFields.ts       # 自定义字段
│
└── docs/                         # 项目文档
    ├── README.md                 # 项目说明
    ├── DEPLOYMENT.md             # 部署指南
    ├── API.md                    # API文档
    └── CONTRIBUTING.md           # 贡献指南
```

## TypeScript配置规范

### tsconfig.json配置
```json
{
  "compilerOptions": {
    "target": "es5",
    "lib": ["dom", "dom.iterable", "es6"],
    "allowJs": true,
    "skipLibCheck": true,
    "strict": true,
    "noEmit": true,
    "esModuleInterop": true,
    "module": "esnext",
    "moduleResolution": "bundler",
    "resolveJsonModule": true,
    "isolatedModules": true,
    "jsx": "preserve",
    "incremental": true,
    "plugins": [
      {
        "name": "next"
      }
    ],
    "baseUrl": ".",
    "paths": {
      "@/*": ["./src/*"],
      "@/components/*": ["./src/components/*"],
      "@/lib/*": ["./src/lib/*"],
      "@/types/*": ["./src/types/*"],
      "@/styles/*": ["./src/styles/*"],
      "@/i18n/*": ["./src/i18n/*"]
    }
  },
  "include": [
    "next-env.d.ts",
    "**/*.ts",
    "**/*.tsx",
    ".next/types/**/*.ts"
  ],
  "exclude": [
    "node_modules"
  ]
}
```

### TypeScript类型定义
```typescript
// src/types/sanity.ts
export interface SanityDocument {
  _id: string;
  _rev: string;
  _type: string;
  _createdAt: string;
  _updatedAt: string;
}

export interface SanityReference {
  _type: 'reference';
  _ref: string;
}

export interface SanityImage {
  _type: 'image';
  asset: {
    _ref: string;
    _type: 'reference';
  };
  alt?: string;
  caption?: string;
}

// src/types/product.ts
export interface Product extends SanityDocument {
  _type: 'product';
  partNumber: string;
  slug: {
    current: string;
  };
  brand: Brand;
  category: ProductCategory;
  subcategory?: ProductSubcategory;
  description: string;
  image?: SanityImage;
  specifications: ProductSpecification[];
  pricing: ProductPricing;
  inventory: ProductInventory;
  documents: ProductDocuments;
  isActive: boolean;
  featured: boolean;
  seoTitle?: string;
  seoDescription?: string;
}

export interface ProductSpecification {
  parameter: string;
  value: string;
  unit?: string;
}

export interface ProductPricing {
  unitPrice: number;
  currency: 'CNY' | 'USD';
  priceBreaks: PriceBreak[];
}

export interface PriceBreak {
  quantity: number;
  price: number;
}

export interface ProductInventory {
  stockQuantity: number;
  stockStatus: 'in-stock' | 'backorder' | 'out-of-stock';
  leadTime?: string;
}

export interface ProductDocuments {
  datasheet?: SanityFile;
  certificate?: SanityFile;
  customsDocument?: SanityFile;
}

// src/types/brand.ts
export interface Brand extends SanityDocument {
  _type: 'brand';
  name: string;
  slug: {
    current: string;
  };
  logo?: SanityImage;
  description: string;
  officialWebsite?: string;
  foundedYear?: number;
  headquarters?: string;
  productCategories: ProductCategory[];
  isActive: boolean;
  seoTitle?: string;
  seoDescription?: string;
}

// src/types/article.ts
export interface Article extends SanityDocument {
  _type: 'article';
  title: string;
  slug: {
    current: string;
  };
  brand?: Brand;
  category: 'selection-guide' | 'application-note' | 'troubleshooting' | 'product-review';
  author: Author;
  publishedAt: string;
  excerpt: string;
  featuredImage?: SanityImage;
  content: PortableTextBlock[];
  tags: Tag[];
  relatedProducts: Product[];
  readingTime?: number;
  featured: boolean;
  seoTitle?: string;
  seoDescription?: string;
}
```

## Next.js配置规范

### next.config.js配置
```javascript
/** @type {import('next').NextConfig} */
const nextConfig = {
  // 基础配置
  reactStrictMode: true,
  swcMinify: true,
  
  // 实验性功能
  experimental: {
    appDir: true,
    serverComponentsExternalPackages: ['@sanity/image-url'],
  },
  
  // 图片优化配置
  images: {
    domains: [
      'cdn.sanity.io',
      'images.unsplash.com',
      'via.placeholder.com'
    ],
    formats: ['image/webp', 'image/avif'],
    deviceSizes: [640, 750, 828, 1080, 1200, 1920, 2048, 3840],
    imageSizes: [16, 32, 48, 64, 96, 128, 256, 384],
  },
  
  // 国际化配置
  i18n: {
    locales: ['zh', 'en', 'ja', 'ko', 'ru', 'vi', 'fr', 'de', 'it', 'tr', 'ar'],
    defaultLocale: 'zh',
    localeDetection: false, // 禁用自动语言检测
  },
  
  // 重写规则
  async rewrites() {
    return [
      {
        source: '/admin/:path*',
        destination: '/studio/:path*',
      },
    ];
  },
  
  // 重定向规则
  async redirects() {
    return [
      {
        source: '/studio',
        destination: '/admin',
        permanent: false,
      },
    ];
  },
  
  // Headers配置
  async headers() {
    return [
      {
        source: '/(.*)',
        headers: [
          {
            key: 'X-Frame-Options',
            value: 'DENY',
          },
          {
            key: 'X-Content-Type-Options',
            value: 'nosniff',
          },
          {
            key: 'Referrer-Policy',
            value: 'strict-origin-when-cross-origin',
          },
        ],
      },
    ];
  },
  
  // 环境变量
  env: {
    CUSTOM_KEY: process.env.CUSTOM_KEY,
  },
  
  // Webpack配置
  webpack: (config, { buildId, dev, isServer, defaultLoaders, webpack }) => {
    // 添加自定义Webpack配置
    config.module.rules.push({
      test: /\.svg$/,
      use: ['@svgr/webpack'],
    });
    
    return config;
  },
};

module.exports = nextConfig;
```

### 环境变量配置
```bash
# .env.local
# Sanity配置
NEXT_PUBLIC_SANITY_PROJECT_ID=oquvb2bs
NEXT_PUBLIC_SANITY_DATASET=production
SANITY_API_TOKEN=skcH3gNsfBNrrk7DlrAqF7ocB0o4QagJoWWQGRhXvZYyh1ULE0ef96EBqZ2kRWCnH6YnRDTo7bUBJn0dpjjLuZIz8S4wkpo0Sb9AXLxfO1Y6gG4agwbw60hskt6aIW1arCcAeM44oS6iZdUQ9jNcWEnOaEIhSYQRynnwKoI5oSixuHwYy9gk

# 网站配置
NEXT_PUBLIC_SITE_URL=https://www.elec-distributor.com
NEXT_PUBLIC_SITE_NAME=力通电子

# 邮件配置
SMTP_HOST=smtp.example.com
SMTP_PORT=587
SMTP_USER=noreply@elec-distributor.com
SMTP_PASS=your-smtp-password

# 分析工具
NEXT_PUBLIC_GA_ID=G-XXXXXXXXXX
NEXT_PUBLIC_HOTJAR_ID=your-hotjar-id

# 其他服务
RECAPTCHA_SECRET_KEY=your-recaptcha-secret
NEXT_PUBLIC_RECAPTCHA_SITE_KEY=your-recaptcha-site-key
```

## Sanity CMS配置

### sanity.config.ts配置
```typescript
import { defineConfig } from 'sanity';
import { deskTool } from 'sanity/desk';
import { visionTool } from '@sanity/vision';
import { codeInput } from '@sanity/code-input';
import { table } from '@sanity/table';
import { media } from 'sanity-plugin-media';

import { schemaTypes } from './sanity/schemas';
import { structure } from './sanity/structure';

export default defineConfig({
  name: 'litong',
  title: 'LiTong Electronics CMS',
  
  projectId: process.env.NEXT_PUBLIC_SANITY_PROJECT_ID!,
  dataset: process.env.NEXT_PUBLIC_SANITY_DATASET!,
  
  basePath: '/admin',
  
  plugins: [
    deskTool({
      structure,
    }),
    visionTool(),
    codeInput(),
    table(),
    media(),
  ],
  
  schema: {
    types: schemaTypes,
  },
  
  document: {
    actions: (prev, context) => {
      return prev.map((originalAction) =>
        originalAction.action === 'delete'
          ? {
              ...originalAction,
              disabled: context.schemaType === 'brand' ? true : false,
            }
          : originalAction
      );
    },
  },
  
  tools: (prev) => {
    return prev.filter((tool) => tool.name !== 'vision' || process.env.NODE_ENV === 'development');
  },
});
```

### GROQ查询示例
```typescript
// src/lib/sanity/queries.ts
export const BRAND_QUERY = `
  *[_type == "brand" && isActive == true] | order(name asc) {
    _id,
    name,
    "slug": slug.current,
    logo,
    description,
    "productCount": count(*[_type == "product" && references(^._id) && isActive == true])
  }
`;

export const PRODUCT_BY_SLUG_QUERY = `
  *[_type == "product" && slug.current == $slug][0] {
    _id,
    partNumber,
    "slug": slug.current,
    brand->{
      _id,
      name,
      "slug": slug.current,
      logo
    },
    category->{
      _id,
      name,
      "slug": slug.current
    },
    subcategory->{
      _id,
      name,
      "slug": slug.current
    },
    description,
    image,
    specifications,
    pricing,
    inventory,
    documents,
    seoTitle,
    seoDescription,
    "relatedProducts": *[_type == "product" && category._ref == ^.category._ref && _id != ^._id][0...4] {
      _id,
      partNumber,
      "slug": slug.current,
      image,
      pricing
    }
  }
`;

export const ARTICLES_QUERY = `
  *[_type == "article" && publishedAt <= now()] | order(publishedAt desc) {
    _id,
    title,
    "slug": slug.current,
    category,
    excerpt,
    featuredImage,
    publishedAt,
    readingTime,
    author->{
      _id,
      name,
      avatar
    },
    tags[]->{
      _id,
      name,
      "slug": slug.current
    }
  }
`;
```

## 性能优化配置

### 图片优化策略
```typescript
// src/lib/utils/image.ts
import imageUrlBuilder from '@sanity/image-url';
import { SanityImageSource } from '@sanity/image-url/lib/types';
import { client } from '@/lib/sanity/client';

const builder = imageUrlBuilder(client);

export function urlFor(source: SanityImageSource) {
  return builder.image(source);
}

// 响应式图片生成
export function generateImageSizes(
  source: SanityImageSource,
  sizes: { width: number; quality?: number }[]
) {
  return sizes.map(({ width, quality = 80 }) => ({
    src: urlFor(source).width(width).quality(quality).format('webp').url(),
    width,
  }));
}

// 图片组件优化
export function getOptimizedImageProps(
  source: SanityImageSource,
  alt: string,
  options: {
    width?: number;
    height?: number;
    quality?: number;
    priority?: boolean;
  } = {}
) {
  const { width = 800, height, quality = 80, priority = false } = options;
  
  return {
    src: urlFor(source).width(width).height(height).quality(quality).format('webp').url(),
    alt,
    width,
    height: height || Math.round(width * 0.75), // 默认4:3比例
    priority,
    sizes: '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw',
    placeholder: 'blur' as const,
    blurDataURL: urlFor(source).width(20).quality(20).format('webp').blur(10).url(),
  };
}
```

### 缓存策略配置
```typescript
// src/lib/cache/config.ts
export const CACHE_CONFIG = {
  // 静态内容缓存时间
  STATIC_CACHE: 60 * 60 * 24 * 30, // 30天
  
  // 动态内容缓存时间  
  DYNAMIC_CACHE: 60 * 15, // 15分钟
  
  // 产品数据缓存时间
  PRODUCT_CACHE: 60 * 60, // 1小时
  
  // 搜索结果缓存时间
  SEARCH_CACHE: 60 * 5, // 5分钟
};

// Next.js页面缓存配置
export const revalidate = CACHE_CONFIG.DYNAMIC_CACHE;

// API路由缓存
export const dynamic = 'auto';
export const dynamicParams = true;
export const fetchCache = 'default-cache';
export const runtime = 'nodejs';
export const preferredRegion = 'auto';
```

### Bundle分析配置
```javascript
// analyze.js
const { BundleAnalyzerPlugin } = require('webpack-bundle-analyzer');

/** @type {import('next').NextConfig} */
const nextConfig = {
  webpack: (config, { isServer }) => {
    if (process.env.ANALYZE === 'true') {
      config.plugins.push(
        new BundleAnalyzerPlugin({
          analyzerMode: 'static',
          reportFilename: isServer
            ? '../analyze/server.html'
            : './analyze/client.html',
        })
      );
    }
    return config;
  },
};

module.exports = nextConfig;
```

## 代码质量配置

### ESLint配置
```json
// .eslintrc.json
{
  "extends": [
    "next/core-web-vitals",
    "@typescript-eslint/recommended",
    "prettier"
  ],
  "parser": "@typescript-eslint/parser",
  "plugins": ["@typescript-eslint"],
  "rules": {
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/no-explicit-any": "warn",
    "react-hooks/exhaustive-deps": "warn",
    "prefer-const": "error",
    "no-console": "warn"
  },
  "ignorePatterns": ["node_modules/", ".next/", "out/"]
}
```

### Prettier配置
```json
// .prettierrc
{
  "semi": true,
  "trailingComma": "es5",
  "singleQuote": true,
  "printWidth": 100,
  "tabWidth": 2,
  "useTabs": false,
  "bracketSpacing": true,
  "arrowParens": "avoid"
}
```

### Husky Git Hooks
```json
// package.json
{
  "husky": {
    "hooks": {
      "pre-commit": "lint-staged",
      "pre-push": "npm run type-check"
    }
  },
  "lint-staged": {
    "*.{js,jsx,ts,tsx}": [
      "eslint --fix",
      "prettier --write"
    ],
    "*.{md,json}": [
      "prettier --write"
    ]
  }
}
```

## 测试配置

### Jest配置
```javascript
// jest.config.js
const nextJest = require('next/jest');

const createJestConfig = nextJest({
  dir: './',
});

const customJestConfig = {
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
  },
  testEnvironment: 'jest-environment-jsdom',
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/types/**/*',
  ],
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 70,
      lines: 70,
      statements: 70,
    },
  },
};

module.exports = createJestConfig(customJestConfig);
```

### 测试脚本示例
```typescript
// src/components/ui/Button/Button.test.tsx
import { render, screen, fireEvent } from '@testing-library/react';
import { Button } from './Button';

describe('Button Component', () => {
  it('renders button with correct text', () => {
    render(<Button>Click me</Button>);
    expect(screen.getByText('Click me')).toBeInTheDocument();
  });

  it('calls onClick handler when clicked', () => {
    const handleClick = jest.fn();
    render(<Button onClick={handleClick}>Click me</Button>);
    
    fireEvent.click(screen.getByText('Click me'));
    expect(handleClick).toHaveBeenCalledTimes(1);
  });

  it('applies correct variant classes', () => {
    render(<Button variant="primary">Primary Button</Button>);
    expect(screen.getByText('Primary Button')).toHaveClass('btn-primary');
  });
});
```