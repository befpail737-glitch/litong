# 测试策略与质量保证

## 测试金字塔设计

### 测试层级结构
```
测试金字塔
├── E2E测试 (10%)
│   ├── 关键用户流程测试
│   ├── 跨浏览器兼容性测试
│   └── 性能回归测试
├── 集成测试 (20%)
│   ├── API集成测试
│   ├── 数据库集成测试
│   ├── 第三方服务集成测试
│   └── 组件集成测试
└── 单元测试 (70%)
    ├── 组件单元测试
    ├── 工具函数测试
    ├── Hook测试
    └── 业务逻辑测试
```

### 测试配置文件
```javascript
// jest.config.js
const nextJest = require('next/jest');

const createJestConfig = nextJest({
  dir: './',
});

const customJestConfig = {
  displayName: 'LiTong Electronics',
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
  testEnvironment: 'jest-environment-jsdom',
  
  // 模块映射
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
    '^@/components/(.*)$': '<rootDir>/src/components/$1',
    '^@/lib/(.*)$': '<rootDir>/src/lib/$1',
    '^@/types/(.*)$': '<rootDir>/src/types/$1',
    '^@/styles/(.*)$': '<rootDir>/src/styles/$1',
  },
  
  // 测试文件匹配规则
  testMatch: [
    '**/__tests__/**/*.(js|jsx|ts|tsx)',
    '**/*.(test|spec).(js|jsx|ts|tsx)',
  ],
  
  // 覆盖率配置
  collectCoverageFrom: [
    'src/**/*.{js,jsx,ts,tsx}',
    '!src/**/*.d.ts',
    '!src/types/**/*',
    '!src/**/*.stories.{js,jsx,ts,tsx}',
    '!src/app/layout.tsx',
    '!src/app/globals.css',
  ],
  
  // 覆盖率阈值
  coverageThreshold: {
    global: {
      branches: 70,
      functions: 75,
      lines: 80,
      statements: 80,
    },
    './src/components/ui/': {
      branches: 80,
      functions: 85,
      lines: 90,
      statements: 90,
    },
    './src/lib/': {
      branches: 75,
      functions: 80,
      lines: 85,
      statements: 85,
    },
  },
  
  // 覆盖率报告
  coverageReporters: [
    'text',
    'lcov',
    'html',
    'json-summary',
  ],
  
  // 并行执行
  maxWorkers: '50%',
  
  // 超时配置
  testTimeout: 10000,
  
  // 忽略模式
  testPathIgnorePatterns: [
    '<rootDir>/.next/',
    '<rootDir>/node_modules/',
    '<rootDir>/e2e/',
  ],
  
  // 模块转换
  transformIgnorePatterns: [
    'node_modules/(?!(.*\\.mjs$|@sanity/ui))',
  ],
};

module.exports = createJestConfig(customJestConfig);
```

## 单元测试规范

### React组件测试
```typescript
// src/components/ui/Button/Button.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import userEvent from '@testing-library/user-event';
import { Button } from './Button';

describe('Button Component', () => {
  // 基础渲染测试
  describe('Rendering', () => {
    it('renders button with correct text', () => {
      render(<Button>Click me</Button>);
      expect(screen.getByText('Click me')).toBeInTheDocument();
    });

    it('renders button with correct variant classes', () => {
      render(<Button variant="primary">Primary Button</Button>);
      const button = screen.getByText('Primary Button');
      expect(button).toHaveClass('btn-primary');
    });

    it('renders disabled button correctly', () => {
      render(<Button disabled>Disabled Button</Button>);
      const button = screen.getByText('Disabled Button');
      expect(button).toBeDisabled();
      expect(button).toHaveClass('opacity-50');
    });

    it('renders button with loading state', () => {
      render(<Button loading>Loading Button</Button>);
      expect(screen.getByText('Loading Button')).toBeInTheDocument();
      expect(screen.getByTestId('loading-spinner')).toBeInTheDocument();
    });

    it('renders button with icon', () => {
      const Icon = () => <span data-testid="test-icon">Icon</span>;
      render(
        <Button icon={<Icon />}>
          Button with Icon
        </Button>
      );
      expect(screen.getByTestId('test-icon')).toBeInTheDocument();
    });
  });

  // 交互测试
  describe('Interactions', () => {
    it('calls onClick handler when clicked', async () => {
      const handleClick = jest.fn();
      const user = userEvent.setup();
      
      render(<Button onClick={handleClick}>Click me</Button>);
      
      await user.click(screen.getByText('Click me'));
      expect(handleClick).toHaveBeenCalledTimes(1);
    });

    it('does not call onClick when disabled', async () => {
      const handleClick = jest.fn();
      const user = userEvent.setup();
      
      render(<Button onClick={handleClick} disabled>Disabled</Button>);
      
      await user.click(screen.getByText('Disabled'));
      expect(handleClick).not.toHaveBeenCalled();
    });

    it('does not call onClick when loading', async () => {
      const handleClick = jest.fn();
      const user = userEvent.setup();
      
      render(<Button onClick={handleClick} loading>Loading</Button>);
      
      await user.click(screen.getByText('Loading'));
      expect(handleClick).not.toHaveBeenCalled();
    });

    it('handles keyboard navigation', async () => {
      const handleClick = jest.fn();
      const user = userEvent.setup();
      
      render(<Button onClick={handleClick}>Button</Button>);
      
      const button = screen.getByText('Button');
      button.focus();
      
      await user.keyboard('{Enter}');
      expect(handleClick).toHaveBeenCalledTimes(1);
      
      await user.keyboard(' ');
      expect(handleClick).toHaveBeenCalledTimes(2);
    });
  });

  // 可访问性测试
  describe('Accessibility', () => {
    it('has correct ARIA attributes', () => {
      render(
        <Button 
          aria-label="Submit form"
          aria-describedby="help-text"
        >
          Submit
        </Button>
      );
      
      const button = screen.getByText('Submit');
      expect(button).toHaveAttribute('aria-label', 'Submit form');
      expect(button).toHaveAttribute('aria-describedby', 'help-text');
    });

    it('announces loading state to screen readers', () => {
      render(<Button loading>Submit</Button>);
      const button = screen.getByText('Submit');
      expect(button).toHaveAttribute('aria-busy', 'true');
    });
  });

  // 样式和主题测试
  describe('Styling', () => {
    it('applies size variants correctly', () => {
      const { rerender } = render(<Button size="sm">Small</Button>);
      expect(screen.getByText('Small')).toHaveClass('btn-sm');
      
      rerender(<Button size="lg">Large</Button>);
      expect(screen.getByText('Large')).toHaveClass('btn-lg');
    });

    it('applies custom className', () => {
      render(<Button className="custom-class">Button</Button>);
      expect(screen.getByText('Button')).toHaveClass('custom-class');
    });
  });
});
```

### 自定义Hook测试
```typescript
// src/lib/hooks/useProducts.test.ts
import { renderHook, waitFor } from '@testing-library/react';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { useProducts } from './useProducts';
import { vi } from 'vitest';

// Mock API
vi.mock('@/lib/api/products', () => ({
  fetchProducts: vi.fn(),
}));

import { fetchProducts } from '@/lib/api/products';

const createWrapper = () => {
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: { retry: false },
      mutations: { retry: false },
    },
  });
  
  return ({ children }: { children: React.ReactNode }) => (
    <QueryClientProvider client={queryClient}>{children}</QueryClientProvider>
  );
};

describe('useProducts Hook', () => {
  beforeEach(() => {
    vi.clearAllMocks();
  });

  it('fetches products successfully', async () => {
    const mockProducts = [
      { id: '1', name: 'Product 1', brand: 'Brand A' },
      { id: '2', name: 'Product 2', brand: 'Brand B' },
    ];

    (fetchProducts as any).mockResolvedValue({
      data: mockProducts,
      total: 2,
    });

    const { result } = renderHook(
      () => useProducts({ category: 'ic' }),
      { wrapper: createWrapper() }
    );

    expect(result.current.isLoading).toBe(true);

    await waitFor(() => {
      expect(result.current.isLoading).toBe(false);
    });

    expect(result.current.data?.data).toEqual(mockProducts);
    expect(result.current.data?.total).toBe(2);
    expect(fetchProducts).toHaveBeenCalledWith({
      category: 'ic',
      page: 1,
      limit: 20,
    });
  });

  it('handles error states', async () => {
    const error = new Error('Failed to fetch products');
    (fetchProducts as any).mockRejectedValue(error);

    const { result } = renderHook(
      () => useProducts({ category: 'ic' }),
      { wrapper: createWrapper() }
    );

    await waitFor(() => {
      expect(result.current.isError).toBe(true);
    });

    expect(result.current.error).toEqual(error);
  });

  it('updates when parameters change', async () => {
    (fetchProducts as any).mockResolvedValue({ data: [], total: 0 });

    const { result, rerender } = renderHook(
      ({ category }) => useProducts({ category }),
      {
        wrapper: createWrapper(),
        initialProps: { category: 'ic' },
      }
    );

    await waitFor(() => {
      expect(result.current.isLoading).toBe(false);
    });

    rerender({ category: 'analog' });

    await waitFor(() => {
      expect(fetchProducts).toHaveBeenCalledWith({
        category: 'analog',
        page: 1,
        limit: 20,
      });
    });
  });

  it('implements pagination correctly', async () => {
    const { result } = renderHook(
      () => useProducts({ category: 'ic', page: 2, limit: 10 }),
      { wrapper: createWrapper() }
    );

    await waitFor(() => {
      expect(fetchProducts).toHaveBeenCalledWith({
        category: 'ic',
        page: 2,
        limit: 10,
      });
    });
  });
});
```

### 工具函数测试
```typescript
// src/lib/utils/format.test.ts
import { formatCurrency, formatNumber, formatDate } from './format';

describe('Format Utilities', () => {
  describe('formatCurrency', () => {
    it('formats CNY currency correctly', () => {
      expect(formatCurrency(1234.56, 'CNY', 'zh')).toBe('￥1,234.56');
      expect(formatCurrency(0, 'CNY', 'zh')).toBe('￥0.00');
      expect(formatCurrency(1000000, 'CNY', 'zh')).toBe('￥1,000,000.00');
    });

    it('formats USD currency correctly', () => {
      expect(formatCurrency(1234.56, 'USD', 'en')).toBe('$1,234.56');
      expect(formatCurrency(0.99, 'USD', 'en')).toBe('$0.99');
    });

    it('formats JPY currency without decimals', () => {
      expect(formatCurrency(1234, 'JPY', 'ja')).toBe('￥1,234');
    });

    it('handles invalid inputs gracefully', () => {
      expect(formatCurrency(NaN, 'CNY', 'zh')).toBe('CNY NaN.00');
      expect(formatCurrency(Infinity, 'CNY', 'zh')).toBe('CNY Infinity.00');
    });
  });

  describe('formatNumber', () => {
    it('formats numbers with locale-specific separators', () => {
      expect(formatNumber(1234567, 'zh')).toBe('1,234,567');
      expect(formatNumber(1234567.89, 'en')).toBe('1,234,567.89');
    });

    it('applies custom formatting options', () => {
      expect(formatNumber(0.1234, 'zh', { 
        style: 'percent',
        minimumFractionDigits: 2,
      })).toBe('12.34%');
    });
  });

  describe('formatDate', () => {
    const testDate = new Date('2024-01-15T10:30:00Z');

    it('formats dates in Chinese locale', () => {
      const result = formatDate(testDate, 'zh');
      expect(result).toContain('2024');
      expect(result).toContain('1月');
      expect(result).toContain('15');
    });

    it('formats dates in English locale', () => {
      const result = formatDate(testDate, 'en');
      expect(result).toContain('2024');
      expect(result).toContain('January');
      expect(result).toContain('15');
    });

    it('handles string date input', () => {
      const result = formatDate('2024-01-15', 'zh');
      expect(result).toContain('2024');
    });

    it('applies custom date formatting options', () => {
      const result = formatDate(testDate, 'zh', {
        year: 'numeric',
        month: 'short',
        day: 'numeric',
        weekday: 'long',
      });
      expect(result).toBeTruthy();
    });
  });
});
```

## 集成测试实现

### API集成测试
```typescript
// src/lib/api/products.integration.test.ts
import { setupServer } from 'msw/node';
import { rest } from 'msw';
import { fetchProducts, fetchProductBySlug } from './products';

// Mock服务器设置
const server = setupServer(
  rest.get('/api/products', (req, res, ctx) => {
    const category = req.url.searchParams.get('category');
    const page = req.url.searchParams.get('page') || '1';
    const limit = req.url.searchParams.get('limit') || '20';

    const mockProducts = Array.from({ length: parseInt(limit) }, (_, i) => ({
      id: `${category}-${i + 1}`,
      name: `Product ${i + 1}`,
      category,
      brand: `Brand ${String.fromCharCode(65 + (i % 26))}`,
      price: 10.0 + i,
      stock: 100 - i,
    }));

    return res(
      ctx.json({
        data: mockProducts,
        total: 1000,
        page: parseInt(page),
        limit: parseInt(limit),
      })
    );
  }),

  rest.get('/api/products/:slug', (req, res, ctx) => {
    const { slug } = req.params;

    if (slug === 'not-found') {
      return res(ctx.status(404), ctx.json({ error: 'Product not found' }));
    }

    return res(
      ctx.json({
        id: slug,
        name: `Product ${slug}`,
        category: 'ic',
        brand: 'Test Brand',
        description: 'Test product description',
        specifications: [
          { parameter: 'Voltage', value: '3.3V', unit: 'V' },
          { parameter: 'Current', value: '100', unit: 'mA' },
        ],
        pricing: {
          unitPrice: 12.5,
          currency: 'CNY',
          priceBreaks: [
            { quantity: 1, price: 12.5 },
            { quantity: 10, price: 11.0 },
          ],
        },
        inventory: {
          stockQuantity: 500,
          stockStatus: 'in-stock',
        },
      })
    );
  })
);

beforeAll(() => server.listen());
afterEach(() => server.resetHandlers());
afterAll(() => server.close());

describe('Products API Integration', () => {
  describe('fetchProducts', () => {
    it('fetches products with filters', async () => {
      const result = await fetchProducts({
        category: 'ic',
        page: 1,
        limit: 10,
      });

      expect(result.data).toHaveLength(10);
      expect(result.total).toBe(1000);
      expect(result.data[0]).toMatchObject({
        id: 'ic-1',
        name: 'Product 1',
        category: 'ic',
      });
    });

    it('handles pagination correctly', async () => {
      const page1 = await fetchProducts({ category: 'ic', page: 1, limit: 5 });
      const page2 = await fetchProducts({ category: 'ic', page: 2, limit: 5 });

      expect(page1.data).toHaveLength(5);
      expect(page2.data).toHaveLength(5);
      expect(page1.data[0].id).not.toBe(page2.data[0].id);
    });

    it('throws error for invalid requests', async () => {
      server.use(
        rest.get('/api/products', (req, res, ctx) => {
          return res(ctx.status(400), ctx.json({ error: 'Invalid request' }));
        })
      );

      await expect(fetchProducts({ category: 'invalid' })).rejects.toThrow(
        'Invalid request'
      );
    });
  });

  describe('fetchProductBySlug', () => {
    it('fetches product details by slug', async () => {
      const product = await fetchProductBySlug('test-product');

      expect(product).toMatchObject({
        id: 'test-product',
        name: 'Product test-product',
        category: 'ic',
        brand: 'Test Brand',
      });

      expect(product.specifications).toHaveLength(2);
      expect(product.pricing.priceBreaks).toHaveLength(2);
    });

    it('throws error for non-existent product', async () => {
      await expect(fetchProductBySlug('not-found')).rejects.toThrow(
        'Product not found'
      );
    });
  });
});
```

### Sanity CMS集成测试
```typescript
// src/lib/sanity/queries.integration.test.ts
import { client } from './client';
import {
  BRAND_QUERY,
  PRODUCT_BY_SLUG_QUERY,
  ARTICLES_QUERY,
} from './queries';

// 注意：这些测试需要连接到Sanity的测试数据集
describe('Sanity Queries Integration', () => {
  beforeAll(() => {
    // 确保使用测试数据集
    process.env.NEXT_PUBLIC_SANITY_DATASET = 'test';
  });

  describe('Brand Queries', () => {
    it('fetches all active brands', async () => {
      const brands = await client.fetch(BRAND_QUERY);

      expect(Array.isArray(brands)).toBe(true);
      
      if (brands.length > 0) {
        expect(brands[0]).toMatchObject({
          _id: expect.any(String),
          name: expect.any(String),
          slug: expect.any(String),
        });

        // 验证productCount字段被正确计算
        expect(typeof brands[0].productCount).toBe('number');
      }
    });

    it('only returns active brands', async () => {
      const brands = await client.fetch(BRAND_QUERY);
      
      // 所有返回的品牌都应该是活跃的
      // 这需要在测试数据中有非活跃品牌作为对照
      expect(brands.every((brand: any) => brand.isActive !== false)).toBe(true);
    });
  });

  describe('Product Queries', () => {
    it('fetches product by slug with relations', async () => {
      // 需要在测试数据集中有一个已知的产品
      const testSlug = 'test-product-1';
      
      const product = await client.fetch(PRODUCT_BY_SLUG_QUERY, {
        slug: testSlug,
      });

      if (product) {
        expect(product).toMatchObject({
          _id: expect.any(String),
          partNumber: expect.any(String),
          slug: testSlug,
        });

        // 验证关联数据被正确获取
        if (product.brand) {
          expect(product.brand).toMatchObject({
            _id: expect.any(String),
            name: expect.any(String),
            slug: expect.any(String),
          });
        }

        if (product.category) {
          expect(product.category).toMatchObject({
            _id: expect.any(String),
            name: expect.any(String),
            slug: expect.any(String),
          });
        }

        // 验证相关产品推荐
        if (product.relatedProducts) {
          expect(Array.isArray(product.relatedProducts)).toBe(true);
          expect(product.relatedProducts.length).toBeLessThanOrEqual(4);
        }
      }
    });

    it('returns null for non-existent product', async () => {
      const product = await client.fetch(PRODUCT_BY_SLUG_QUERY, {
        slug: 'non-existent-product',
      });

      expect(product).toBeNull();
    });
  });

  describe('Article Queries', () => {
    it('fetches published articles with authors and tags', async () => {
      const articles = await client.fetch(ARTICLES_QUERY);

      expect(Array.isArray(articles)).toBe(true);

      if (articles.length > 0) {
        const article = articles[0];
        
        expect(article).toMatchObject({
          _id: expect.any(String),
          title: expect.any(String),
          slug: expect.any(String),
          category: expect.any(String),
        });

        // 验证作者信息
        if (article.author) {
          expect(article.author).toMatchObject({
            _id: expect.any(String),
            name: expect.any(String),
          });
        }

        // 验证标签信息
        if (article.tags && article.tags.length > 0) {
          expect(article.tags[0]).toMatchObject({
            _id: expect.any(String),
            name: expect.any(String),
            slug: expect.any(String),
          });
        }

        // 验证发布时间不是未来时间
        expect(new Date(article.publishedAt) <= new Date()).toBe(true);
      }
    });

    it('orders articles by published date descending', async () => {
      const articles = await client.fetch(ARTICLES_QUERY);

      if (articles.length > 1) {
        for (let i = 0; i < articles.length - 1; i++) {
          const current = new Date(articles[i].publishedAt);
          const next = new Date(articles[i + 1].publishedAt);
          expect(current >= next).toBe(true);
        }
      }
    });
  });
});
```

## E2E测试实现

### Playwright配置
```typescript
// playwright.config.ts
import { defineConfig, devices } from '@playwright/test';

export default defineConfig({
  testDir: './e2e',
  
  // 并行运行测试
  fullyParallel: true,
  
  // 失败时重试次数
  retries: process.env.CI ? 2 : 0,
  
  // 并行工作进程数
  workers: process.env.CI ? 1 : undefined,
  
  // 报告配置
  reporter: [
    ['html'],
    ['json', { outputFile: 'test-results/results.json' }],
    process.env.CI ? ['github'] : ['list'],
  ],
  
  use: {
    // 基础URL
    baseURL: process.env.BASE_URL || 'http://localhost:3000',
    
    // 浏览器配置
    trace: 'on-first-retry',
    screenshot: 'only-on-failure',
    video: 'retain-on-failure',
    
    // 超时配置
    actionTimeout: 10000,
    navigationTimeout: 30000,
  },

  // 项目配置（多浏览器测试）
  projects: [
    {
      name: 'chromium',
      use: { ...devices['Desktop Chrome'] },
    },
    {
      name: 'firefox',
      use: { ...devices['Desktop Firefox'] },
    },
    {
      name: 'webkit',
      use: { ...devices['Desktop Safari'] },
    },
    {
      name: 'Mobile Chrome',
      use: { ...devices['Pixel 5'] },
    },
    {
      name: 'Mobile Safari',
      use: { ...devices['iPhone 12'] },
    },
  ],

  // 开发服务器配置
  webServer: process.env.CI ? undefined : {
    command: 'npm run dev',
    port: 3000,
    reuseExistingServer: !process.env.CI,
  },
});
```

### 核心用户流程测试
```typescript
// e2e/user-journeys/product-inquiry.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Product Inquiry Journey', () => {
  test('complete product inquiry flow', async ({ page }) => {
    // 1. 访问首页
    await page.goto('/');
    await expect(page).toHaveTitle(/力通电子/);
    
    // 2. 搜索产品
    const searchInput = page.getByPlaceholder('搜索产品型号或关键词');
    await searchInput.fill('STM32F103C8T6');
    await page.getByRole('button', { name: '搜索' }).click();
    
    // 3. 等待搜索结果加载
    await page.waitForSelector('[data-testid="search-results"]');
    await expect(page.getByText('找到')).toBeVisible();
    
    // 4. 点击产品详情
    await page.getByTestId('product-card').first().click();
    
    // 5. 验证产品详情页
    await expect(page.getByRole('heading', { level: 1 })).toContainText('STM32F103C8T6');
    await expect(page.getByText('技术规格')).toBeVisible();
    await expect(page.getByText('价格信息')).toBeVisible();
    
    // 6. 点击询价按钮
    await page.getByRole('button', { name: '立即询价' }).click();
    
    // 7. 填写询价表单
    await page.getByLabel('询价数量').fill('100');
    await page.getByLabel('联系人').fill('张三');
    await page.getByLabel('联系电话').fill('13800138000');
    await page.getByLabel('邮箱地址').fill('zhangsan@example.com');
    await page.getByLabel('公司名称').fill('测试公司');
    await page.getByLabel('应用场景').fill('智能硬件开发');
    
    // 8. 同意条款
    await page.getByLabel('我已阅读并同意服务条款').check();
    await page.getByLabel('我已阅读并同意隐私政策').check();
    
    // 9. 提交询价
    await page.getByRole('button', { name: '提交询价申请' }).click();
    
    // 10. 验证成功提示
    await expect(page.getByText('询价申请已提交')).toBeVisible();
    await expect(page.getByText('我们会尽快与您联系')).toBeVisible();
  });

  test('handles form validation errors', async ({ page }) => {
    await page.goto('/products/microcontrollers/stm32f103c8t6');
    
    // 直接点击询价按钮，不填写表单
    await page.getByRole('button', { name: '立即询价' }).click();
    await page.getByRole('button', { name: '提交询价申请' }).click();
    
    // 验证验证错误消息
    await expect(page.getByText('数量必须大于0')).toBeVisible();
    await expect(page.getByText('姓名至少2个字符')).toBeVisible();
    await expect(page.getByText('请输入有效的手机号码')).toBeVisible();
    await expect(page.getByText('请输入有效的邮箱地址')).toBeVisible();
  });

  test('inquiry form rate limiting', async ({ page }) => {
    // 快速提交多次询价请求
    for (let i = 0; i < 6; i++) {
      await page.goto('/products/microcontrollers/stm32f103c8t6');
      
      await page.getByRole('button', { name: '立即询价' }).click();
      
      // 填写最少必需字段
      await page.getByLabel('询价数量').fill('1');
      await page.getByLabel('联系人').fill('测试用户');
      await page.getByLabel('联系电话').fill('13800138000');
      await page.getByLabel('邮箱地址').fill(`test${i}@example.com`);
      await page.getByLabel('我已阅读并同意服务条款').check();
      await page.getByLabel('我已阅读并同意隐私政策').check();
      
      await page.getByRole('button', { name: '提交询价申请' }).click();
      
      if (i < 5) {
        // 前5次应该成功
        await expect(page.getByText('询价申请已提交')).toBeVisible();
      } else {
        // 第6次应该被限制
        await expect(page.getByText('请求过于频繁')).toBeVisible();
      }
    }
  });
});
```

### 性能测试
```typescript
// e2e/performance/core-vitals.spec.ts
import { test, expect } from '@playwright/test';

test.describe('Core Web Vitals', () => {
  test('homepage performance metrics', async ({ page }) => {
    // 开始性能测试
    await page.goto('/', { waitUntil: 'networkidle' });
    
    // 测量Core Web Vitals
    const vitals = await page.evaluate(() => {
      return new Promise((resolve) => {
        const vitals: any = {};
        
        // LCP (Largest Contentful Paint)
        new PerformanceObserver((list) => {
          const entries = list.getEntries();
          const lastEntry = entries[entries.length - 1];
          vitals.LCP = lastEntry.startTime;
        }).observe({ entryTypes: ['largest-contentful-paint'] });
        
        // FID (First Input Delay) - 需要真实交互
        new PerformanceObserver((list) => {
          const firstEntry = list.getEntries()[0];
          vitals.FID = firstEntry.processingStart - firstEntry.startTime;
        }).observe({ entryTypes: ['first-input'] });
        
        // CLS (Cumulative Layout Shift)
        let clsValue = 0;
        new PerformanceObserver((list) => {
          for (const entry of list.getEntries()) {
            if (!(entry as any).hadRecentInput) {
              clsValue += (entry as any).value;
            }
          }
          vitals.CLS = clsValue;
        }).observe({ entryTypes: ['layout-shift'] });
        
        // TTFB (Time to First Byte)
        const navigation = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
        vitals.TTFB = navigation.responseStart - navigation.fetchStart;
        
        // FCP (First Contentful Paint)
        const paintEntries = performance.getEntriesByType('paint');
        const fcpEntry = paintEntries.find(entry => entry.name === 'first-contentful-paint');
        vitals.FCP = fcpEntry?.startTime || 0;
        
        setTimeout(() => resolve(vitals), 3000);
      });
    });
    
    console.log('Performance Metrics:', vitals);
    
    // 验证性能指标
    expect(vitals.TTFB).toBeLessThan(600); // < 600ms
    expect(vitals.FCP).toBeLessThan(1800); // < 1.8s
    expect(vitals.LCP).toBeLessThan(2500); // < 2.5s
    expect(vitals.CLS).toBeLessThan(0.1); // < 0.1
  });

  test('product page load performance', async ({ page }) => {
    const startTime = Date.now();
    
    await page.goto('/products/microcontrollers/stm32f103c8t6');
    
    // 等待关键内容加载
    await page.waitForSelector('h1');
    await page.waitForSelector('[data-testid="product-specs"]');
    await page.waitForSelector('[data-testid="product-pricing"]');
    
    const loadTime = Date.now() - startTime;
    console.log(`Product page load time: ${loadTime}ms`);
    
    expect(loadTime).toBeLessThan(3000); // < 3s
  });

  test('search performance', async ({ page }) => {
    await page.goto('/');
    
    const searchInput = page.getByPlaceholder('搜索产品型号或关键词');
    
    const startTime = Date.now();
    await searchInput.fill('STM32');
    
    // 等待搜索建议出现
    await page.waitForSelector('[data-testid="search-suggestions"]');
    
    const searchTime = Date.now() - startTime;
    console.log(`Search response time: ${searchTime}ms`);
    
    expect(searchTime).toBeLessThan(500); // < 500ms
  });
});
```

## 代码质量检查

### ESLint规则配置
```json
// .eslintrc.json
{
  "extends": [
    "next/core-web-vitals",
    "@typescript-eslint/recommended",
    "@typescript-eslint/recommended-requiring-type-checking",
    "prettier"
  ],
  "parser": "@typescript-eslint/parser",
  "parserOptions": {
    "project": "./tsconfig.json"
  },
  "plugins": [
    "@typescript-eslint",
    "react-hooks",
    "jsx-a11y"
  ],
  "rules": {
    // TypeScript规则
    "@typescript-eslint/no-unused-vars": "error",
    "@typescript-eslint/no-explicit-any": "warn",
    "@typescript-eslint/explicit-function-return-type": "off",
    "@typescript-eslint/explicit-module-boundary-types": "off",
    "@typescript-eslint/no-unsafe-assignment": "warn",
    "@typescript-eslint/no-unsafe-member-access": "warn",
    
    // React规则
    "react-hooks/rules-of-hooks": "error",
    "react-hooks/exhaustive-deps": "warn",
    "react/prop-types": "off",
    "react/react-in-jsx-scope": "off",
    
    // 可访问性规则
    "jsx-a11y/alt-text": "error",
    "jsx-a11y/anchor-has-content": "error",
    "jsx-a11y/aria-props": "error",
    "jsx-a11y/aria-proptypes": "error",
    "jsx-a11y/aria-unsupported-elements": "error",
    
    // 通用代码质量规则
    "prefer-const": "error",
    "no-console": "warn",
    "no-debugger": "error",
    "no-alert": "warn",
    "eqeqeq": "error",
    "curly": "error",
    
    // 导入规则
    "sort-imports": ["error", { "ignoreDeclarationSort": true }],
  },
  "settings": {
    "react": {
      "version": "detect"
    }
  },
  "ignorePatterns": [
    "node_modules/",
    ".next/",
    "out/",
    "public/",
    "*.config.js",
    "*.config.ts"
  ]
}
```

### 代码覆盖率报告
```bash
# package.json scripts
{
  "scripts": {
    "test": "jest",
    "test:watch": "jest --watch",
    "test:coverage": "jest --coverage",
    "test:ci": "jest --coverage --watchAll=false --passWithNoTests",
    "test:e2e": "playwright test",
    "test:e2e:ui": "playwright test --ui",
    "test:performance": "playwright test e2e/performance",
    "lint": "next lint",
    "lint:fix": "next lint --fix",
    "type-check": "tsc --noEmit",
    "quality:check": "npm run lint && npm run type-check && npm run test:ci"
  }
}
```