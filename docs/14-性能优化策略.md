# 性能优化策略

## Core Web Vitals优化

### LCP (Largest Contentful Paint) 优化
```typescript
// 目标: < 2.5秒
// 优化策略：

// 1. 图片优化
// src/components/common/OptimizedImage/OptimizedImage.tsx
import Image from 'next/image';
import { useState } from 'react';

interface OptimizedImageProps {
  src: string;
  alt: string;
  width: number;
  height: number;
  priority?: boolean;
  className?: string;
  sizes?: string;
  placeholder?: 'blur' | 'empty';
  blurDataURL?: string;
}

export function OptimizedImage({
  src,
  alt,
  width,
  height,
  priority = false,
  className = '',
  sizes = '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw',
  placeholder = 'blur',
  blurDataURL,
}: OptimizedImageProps) {
  const [isLoading, setIsLoading] = useState(true);
  const [hasError, setHasError] = useState(false);

  // 生成模糊占位符
  const defaultBlurDataURL = blurDataURL || generateBlurDataURL(width, height);

  return (
    <div className={`relative overflow-hidden ${className}`}>
      {isLoading && (
        <div 
          className="absolute inset-0 bg-gray-200 animate-pulse"
          style={{ aspectRatio: `${width}/${height}` }}
        />
      )}
      
      {hasError ? (
        <div 
          className="flex items-center justify-center bg-gray-100 text-gray-400"
          style={{ width, height }}
        >
          <svg className="w-8 h-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
        </div>
      ) : (
        <Image
          src={src}
          alt={alt}
          width={width}
          height={height}
          priority={priority}
          sizes={sizes}
          placeholder={placeholder}
          blurDataURL={defaultBlurDataURL}
          quality={85}
          onLoad={() => setIsLoading(false)}
          onError={() => {
            setIsLoading(false);
            setHasError(true);
          }}
          className={`transition-opacity duration-300 ${
            isLoading ? 'opacity-0' : 'opacity-100'
          }`}
        />
      )}
    </div>
  );
}

function generateBlurDataURL(width: number, height: number): string {
  const canvas = document.createElement('canvas');
  canvas.width = width;
  canvas.height = height;
  const ctx = canvas.getContext('2d');
  
  if (!ctx) return '';
  
  // 创建渐变背景
  const gradient = ctx.createLinearGradient(0, 0, width, height);
  gradient.addColorStop(0, '#f3f4f6');
  gradient.addColorStop(1, '#e5e7eb');
  
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, width, height);
  
  return canvas.toDataURL();
}

// 2. 关键资源预加载
// src/components/common/ResourcePreloader/ResourcePreloader.tsx
'use client';

import { useEffect } from 'react';

interface PreloadResource {
  href: string;
  as: 'style' | 'script' | 'font' | 'image';
  type?: string;
  crossOrigin?: string;
}

const criticalResources: PreloadResource[] = [
  // 关键CSS
  { href: '/styles/critical.css', as: 'style' },
  
  // 关键字体
  { 
    href: '/fonts/inter-var.woff2', 
    as: 'font', 
    type: 'font/woff2',
    crossOrigin: 'anonymous'
  },
  
  // Hero图片
  { href: '/images/hero-banner.webp', as: 'image' },
  
  // 关键JavaScript
  { href: '/_next/static/chunks/main.js', as: 'script' },
];

export function ResourcePreloader() {
  useEffect(() => {
    criticalResources.forEach(resource => {
      const link = document.createElement('link');
      link.rel = 'preload';
      link.href = resource.href;
      link.as = resource.as;
      
      if (resource.type) link.type = resource.type;
      if (resource.crossOrigin) link.crossOrigin = resource.crossOrigin;
      
      document.head.appendChild(link);
    });
  }, []);

  return null;
}

// 3. 关键路径CSS内联
// src/lib/styles/critical-css.ts
export const criticalCSS = `
  /* 关键路径样式 */
  .hero-banner {
    background-color: #f8fafc;
    min-height: 60vh;
  }
  
  .navigation {
    position: sticky;
    top: 0;
    z-index: 50;
  }
  
  .loading-skeleton {
    background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
    background-size: 200% 100%;
    animation: loading 1.5s infinite;
  }
  
  @keyframes loading {
    0% { background-position: 200% 0; }
    100% { background-position: -200% 0; }
  }
`;
```

### FID (First Input Delay) 优化
```typescript
// 目标: < 100毫秒
// 优化策略：

// 1. 代码分割和懒加载
// src/components/features/ProductFilter/ProductFilter.lazy.tsx
import { lazy, Suspense } from 'react';
import { ProductFilterSkeleton } from './ProductFilterSkeleton';

const ProductFilter = lazy(() => 
  import('./ProductFilter').then(module => ({
    default: module.ProductFilter
  }))
);

export function LazyProductFilter(props: any) {
  return (
    <Suspense fallback={<ProductFilterSkeleton />}>
      <ProductFilter {...props} />
    </Suspense>
  );
}

// 2. 交互优化 - 防抖和节流
// src/lib/hooks/useDebounce.ts
import { useCallback, useRef } from 'react';

export function useDebounce<T extends (...args: any[]) => void>(
  callback: T,
  delay: number
): T {
  const timeoutRef = useRef<NodeJS.Timeout>();

  return useCallback((...args: Parameters<T>) => {
    if (timeoutRef.current) {
      clearTimeout(timeoutRef.current);
    }
    
    timeoutRef.current = setTimeout(() => {
      callback(...args);
    }, delay);
  }, [callback, delay]) as T;
}

// 使用示例
export function SearchInput() {
  const [query, setQuery] = useState('');
  const [results, setResults] = useState([]);
  
  const debouncedSearch = useDebounce(async (searchQuery: string) => {
    if (searchQuery.length < 2) return;
    
    const results = await searchProducts(searchQuery);
    setResults(results);
  }, 300);

  const handleInputChange = (e: React.ChangeEvent<HTMLInputElement>) => {
    const value = e.target.value;
    setQuery(value);
    debouncedSearch(value);
  };

  return (
    <input
      type="text"
      value={query}
      onChange={handleInputChange}
      placeholder="搜索产品..."
    />
  );
}

// 3. Web Workers for CPU-intensive tasks
// src/workers/productProcessor.worker.ts
interface ProductData {
  id: string;
  name: string;
  specs: Record<string, any>;
  price: number;
}

interface ProcessingMessage {
  type: 'FILTER_PRODUCTS' | 'SORT_PRODUCTS' | 'CALCULATE_STATISTICS';
  payload: any;
}

self.addEventListener('message', (event: MessageEvent<ProcessingMessage>) => {
  const { type, payload } = event.data;

  switch (type) {
    case 'FILTER_PRODUCTS':
      const filtered = filterProducts(payload.products, payload.filters);
      self.postMessage({ type: 'FILTER_COMPLETE', payload: filtered });
      break;

    case 'SORT_PRODUCTS':
      const sorted = sortProducts(payload.products, payload.sortBy);
      self.postMessage({ type: 'SORT_COMPLETE', payload: sorted });
      break;

    case 'CALCULATE_STATISTICS':
      const stats = calculateStatistics(payload.products);
      self.postMessage({ type: 'STATS_COMPLETE', payload: stats });
      break;
  }
});

function filterProducts(products: ProductData[], filters: any): ProductData[] {
  return products.filter(product => {
    // 复杂的筛选逻辑
    return Object.entries(filters).every(([key, value]) => {
      if (!value) return true;
      
      switch (key) {
        case 'priceRange':
          return product.price >= value.min && product.price <= value.max;
        case 'specs':
          return Object.entries(value).every(([specKey, specValue]) => {
            return product.specs[specKey] === specValue;
          });
        default:
          return true;
      }
    });
  });
}

function sortProducts(products: ProductData[], sortBy: string): ProductData[] {
  return [...products].sort((a, b) => {
    switch (sortBy) {
      case 'price-asc':
        return a.price - b.price;
      case 'price-desc':
        return b.price - a.price;
      case 'name':
        return a.name.localeCompare(b.name);
      default:
        return 0;
    }
  });
}

function calculateStatistics(products: ProductData[]) {
  return {
    total: products.length,
    averagePrice: products.reduce((sum, p) => sum + p.price, 0) / products.length,
    priceRange: {
      min: Math.min(...products.map(p => p.price)),
      max: Math.max(...products.map(p => p.price)),
    },
  };
}

// 4. 使用Web Worker的Hook
// src/lib/hooks/useWebWorker.ts
import { useCallback, useEffect, useRef, useState } from 'react';

export function useWebWorker<TMessage, TResult>(
  workerScript: string
) {
  const workerRef = useRef<Worker | null>(null);
  const [isLoading, setIsLoading] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    workerRef.current = new Worker(workerScript);

    workerRef.current.onerror = (error) => {
      setError(error.message);
      setIsLoading(false);
    };

    return () => {
      workerRef.current?.terminate();
    };
  }, [workerScript]);

  const postMessage = useCallback((message: TMessage): Promise<TResult> => {
    return new Promise((resolve, reject) => {
      if (!workerRef.current) {
        reject(new Error('Worker not initialized'));
        return;
      }

      setIsLoading(true);
      setError(null);

      const handleMessage = (event: MessageEvent<TResult>) => {
        workerRef.current?.removeEventListener('message', handleMessage);
        setIsLoading(false);
        resolve(event.data);
      };

      workerRef.current.addEventListener('message', handleMessage);
      workerRef.current.postMessage(message);
    });
  }, []);

  return { postMessage, isLoading, error };
}
```

### CLS (Cumulative Layout Shift) 优化
```typescript
// 目标: < 0.1
// 优化策略：

// 1. 预定义尺寸的容器
// src/components/layout/PreservedLayoutContainer.tsx
interface PreservedLayoutContainerProps {
  width?: number | string;
  height?: number | string;
  aspectRatio?: string;
  children: React.ReactNode;
  className?: string;
}

export function PreservedLayoutContainer({
  width,
  height,
  aspectRatio,
  children,
  className = '',
}: PreservedLayoutContainerProps) {
  const style: React.CSSProperties = {
    width: width,
    height: height,
    aspectRatio: aspectRatio,
  };

  return (
    <div 
      className={`relative ${className}`}
      style={style}
    >
      {children}
    </div>
  );
}

// 2. 骨架屏组件
// src/components/ui/Skeleton/Skeleton.tsx
interface SkeletonProps {
  width?: number | string;
  height?: number | string;
  className?: string;
  variant?: 'text' | 'rectangular' | 'circular';
  animation?: 'pulse' | 'wave' | 'none';
}

export function Skeleton({
  width = '100%',
  height = 20,
  className = '',
  variant = 'text',
  animation = 'pulse',
}: SkeletonProps) {
  const baseClasses = 'bg-gray-200';
  
  const variantClasses = {
    text: 'rounded',
    rectangular: 'rounded-md',
    circular: 'rounded-full',
  };
  
  const animationClasses = {
    pulse: 'animate-pulse',
    wave: 'animate-wave',
    none: '',
  };

  return (
    <div
      className={`
        ${baseClasses} 
        ${variantClasses[variant]} 
        ${animationClasses[animation]} 
        ${className}
      `}
      style={{ width, height }}
    />
  );
}

// 3. 产品卡片骨架屏
// src/components/features/ProductCard/ProductCardSkeleton.tsx
export function ProductCardSkeleton() {
  return (
    <div className="border rounded-lg p-4 space-y-4">
      {/* 产品图片占位 */}
      <PreservedLayoutContainer aspectRatio="4/3">
        <Skeleton variant="rectangular" className="w-full h-full" />
      </PreservedLayoutContainer>
      
      {/* 产品信息占位 */}
      <div className="space-y-2">
        <Skeleton width="80%" height={20} />
        <Skeleton width="60%" height={16} />
        <Skeleton width="90%" height={16} />
      </div>
      
      {/* 价格信息占位 */}
      <div className="flex justify-between items-center">
        <Skeleton width={80} height={24} />
        <Skeleton width={60} height={32} variant="rectangular" />
      </div>
    </div>
  );
}

// 4. 动态内容预留空间
// src/components/features/ProductGrid/ProductGrid.tsx
interface ProductGridProps {
  products?: Product[];
  isLoading?: boolean;
  columns?: number;
}

export function ProductGrid({ 
  products = [], 
  isLoading = false,
  columns = 4 
}: ProductGridProps) {
  // 预留最小数量的占位符
  const skeletonCount = products.length || 12;
  
  if (isLoading) {
    return (
      <div className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-${columns} gap-6`}>
        {Array.from({ length: skeletonCount }).map((_, index) => (
          <ProductCardSkeleton key={`skeleton-${index}`} />
        ))}
      </div>
    );
  }

  return (
    <div className={`grid grid-cols-1 md:grid-cols-2 lg:grid-cols-${columns} gap-6`}>
      {products.map(product => (
        <ProductCard key={product.id} product={product} />
      ))}
    </div>
  );
}

// 5. 字体加载优化
// src/app/layout.tsx
import { Inter } from 'next/font/google';

const inter = Inter({
  subsets: ['latin', 'latin-ext'],
  variable: '--font-inter',
  display: 'swap', // 重要：防止字体加载时的布局偏移
  fallback: ['system-ui', 'arial'], // 回退字体
  preload: true,
});

export default function RootLayout({
  children,
}: {
  children: React.ReactNode;
}) {
  return (
    <html lang="zh" className={inter.variable}>
      <head>
        {/* 预加载关键字体 */}
        <link
          rel="preload"
          href="/fonts/inter-var.woff2"
          as="font"
          type="font/woff2"
          crossOrigin="anonymous"
        />
      </head>
      <body className="font-inter">
        {children}
      </body>
    </html>
  );
}
```

## Bundle优化策略

### 代码分割配置
```typescript
// next.config.js
/** @type {import('next').NextConfig} */
const nextConfig = {
  // 实验性功能
  experimental: {
    optimizeCss: true,
    optimizePackageImports: [
      '@sanity/ui',
      '@headlessui/react',
      'lucide-react',
    ],
  },

  // Webpack配置
  webpack: (config, { buildId, dev, isServer, defaultLoaders, nextRuntime, webpack }) => {
    // 优化Bundle分割
    config.optimization = {
      ...config.optimization,
      splitChunks: {
        chunks: 'all',
        cacheGroups: {
          // 供应商库分组
          vendor: {
            test: /[\\/]node_modules[\\/]/,
            name: 'vendors',
            priority: 20,
            chunks: 'all',
          },
          
          // UI组件库分组
          ui: {
            test: /[\\/]node_modules[\\/](@headlessui|lucide-react)[\\/]/,
            name: 'ui',
            priority: 30,
            chunks: 'all',
          },
          
          // Sanity相关分组
          sanity: {
            test: /[\\/]node_modules[\\/](@sanity)[\\/]/,
            name: 'sanity',
            priority: 30,
            chunks: 'all',
          },
          
          // 通用组件分组
          common: {
            name: 'common',
            minChunks: 2,
            priority: 10,
            chunks: 'all',
            enforce: true,
          },
        },
      },
    };

    // 分析Bundle大小
    if (process.env.ANALYZE === 'true') {
      const { BundleAnalyzerPlugin } = require('webpack-bundle-analyzer');
      config.plugins.push(
        new BundleAnalyzerPlugin({
          analyzerMode: 'static',
          reportFilename: isServer
            ? '../analyze/server.html'
            : './analyze/client.html',
        })
      );
    }

    return config;
  },

  // 编译器优化
  compiler: {
    removeConsole: process.env.NODE_ENV === 'production',
  },
};

module.exports = nextConfig;

// 2. 动态导入组件
// src/components/features/ChartComponent/ChartComponent.lazy.tsx
import dynamic from 'next/dynamic';
import { ChartSkeleton } from './ChartSkeleton';

export const LazyChartComponent = dynamic(
  () => import('./ChartComponent').then(mod => ({ default: mod.ChartComponent })),
  {
    loading: () => <ChartSkeleton />,
    ssr: false, // 客户端渲染
  }
);

// 3. 第三方库按需导入
// src/lib/utils/chart.ts - 错误的导入方式
// import * as d3 from 'd3'; // ❌ 导入整个库

// 正确的导入方式
import { select, scaleLinear, axisBottom, axisLeft } from 'd3'; // ✅ 按需导入

// 4. 图标库优化
// src/components/ui/Icon/Icon.tsx
import dynamic from 'next/dynamic';

// 动态导入图标
const iconComponents = {
  search: dynamic(() => import('lucide-react').then(mod => ({ default: mod.Search }))),
  menu: dynamic(() => import('lucide-react').then(mod => ({ default: mod.Menu }))),
  user: dynamic(() => import('lucide-react').then(mod => ({ default: mod.User }))),
  // 只导入实际使用的图标
};

interface IconProps {
  name: keyof typeof iconComponents;
  size?: number;
  className?: string;
}

export function Icon({ name, size = 24, className = '' }: IconProps) {
  const IconComponent = iconComponents[name];
  
  if (!IconComponent) {
    console.warn(`Icon "${name}" not found`);
    return null;
  }
  
  return (
    <IconComponent 
      size={size} 
      className={className}
    />
  );
}
```

### Tree Shaking优化
```typescript
// 1. 确保模块支持Tree Shaking
// src/lib/utils/index.ts - 使用命名导出
export { formatCurrency } from './format';
export { debounce } from './timing';
export { validateEmail } from './validation';

// ❌ 避免默认导出的聚合
// export { default as formatUtils } from './format';

// 2. 优化第三方库导入
// ❌ 错误方式 - 导入整个库
// import _ from 'lodash';
// import * as date from 'date-fns';

// ✅ 正确方式 - 按需导入
import { debounce, throttle } from 'lodash-es'; // 使用ES模块版本
import { format, parseISO } from 'date-fns';

// 3. 自定义Babel插件配置
// babel.config.js
module.exports = {
  presets: ['next/babel'],
  plugins: [
    // 优化lodash导入
    ['lodash', { id: ['lodash', 'recompose'] }],
    
    // 优化ant design导入（如果使用）
    ['import', {
      libraryName: 'antd',
      libraryDirectory: 'es',
      style: true
    }, 'antd'],
    
    // 优化date-fns导入
    ['date-fns', {
      useEsModules: true
    }]
  ]
};

// 4. 自定义工具函数以减少依赖
// src/lib/utils/lightweight.ts
// 替代lodash的轻量级实现
export function debounce<T extends (...args: any[]) => void>(
  func: T,
  delay: number
): (...args: Parameters<T>) => void {
  let timeoutId: NodeJS.Timeout;
  
  return (...args: Parameters<T>) => {
    clearTimeout(timeoutId);
    timeoutId = setTimeout(() => func(...args), delay);
  };
}

export function throttle<T extends (...args: any[]) => void>(
  func: T,
  limit: number
): (...args: Parameters<T>) => void {
  let inThrottle: boolean;
  
  return (...args: Parameters<T>) => {
    if (!inThrottle) {
      func(...args);
      inThrottle = true;
      setTimeout(() => inThrottle = false, limit);
    }
  };
}

export function pick<T, K extends keyof T>(obj: T, keys: K[]): Pick<T, K> {
  const result = {} as Pick<T, K>;
  keys.forEach(key => {
    if (key in obj) {
      result[key] = obj[key];
    }
  });
  return result;
}

export function omit<T, K extends keyof T>(obj: T, keys: K[]): Omit<T, K> {
  const result = { ...obj } as any;
  keys.forEach(key => {
    delete result[key];
  });
  return result;
}
```

## 缓存优化策略

### HTTP缓存配置
```typescript
// src/lib/cache/http-cache.ts
export const cacheHeaders = {
  // 静态资源 - 长期缓存
  static: {
    'Cache-Control': 'public, max-age=31536000, immutable',
    'Vary': 'Accept-Encoding',
  },
  
  // HTML页面 - 短期缓存
  html: {
    'Cache-Control': 'public, max-age=3600, s-maxage=86400, stale-while-revalidate=86400',
    'Vary': 'Accept-Encoding, Accept-Language',
  },
  
  // API响应 - 根据内容缓存
  api: {
    dynamic: {
      'Cache-Control': 'private, no-cache',
    },
    static: {
      'Cache-Control': 'public, max-age=300, s-maxage=3600',
      'Vary': 'Accept-Encoding',
    },
  },
  
  // 图片资源 - 长期缓存
  images: {
    'Cache-Control': 'public, max-age=31536000',
    'Vary': 'Accept',
  },
};

// Next.js middleware中设置缓存头
// middleware.ts
import { NextResponse } from 'next/server';
import type { NextRequest } from 'next/server';
import { cacheHeaders } from '@/lib/cache/http-cache';

export function middleware(request: NextRequest) {
  const response = NextResponse.next();
  const pathname = request.nextUrl.pathname;

  // 静态资源缓存
  if (pathname.startsWith('/_next/static/') || 
      pathname.match(/\.(js|css|png|jpg|jpeg|gif|svg|woff|woff2|ttf|eot|ico)$/)) {
    Object.entries(cacheHeaders.static).forEach(([key, value]) => {
      response.headers.set(key, value);
    });
  }
  
  // API路由缓存
  else if (pathname.startsWith('/api/')) {
    const isStaticApi = pathname.match(/\/(brands|categories|static-content)/);
    const headers = isStaticApi ? cacheHeaders.api.static : cacheHeaders.api.dynamic;
    
    Object.entries(headers).forEach(([key, value]) => {
      response.headers.set(key, value);
    });
  }
  
  // HTML页面缓存
  else {
    Object.entries(cacheHeaders.html).forEach(([key, value]) => {
      response.headers.set(key, value);
    });
  }

  return response;
}

export const config = {
  matcher: [
    /*
     * Match all request paths except for the ones starting with:
     * - admin (Sanity Studio)
     * - _next/webpack-hmr (development hot reload)
     */
    '/((?!admin|_next/webpack-hmr).*)',
  ],
};
```

### Service Worker缓存
```typescript
// public/sw.js
const CACHE_NAME = 'litong-v1';
const STATIC_CACHE = 'litong-static-v1';
const DYNAMIC_CACHE = 'litong-dynamic-v1';

// 需要缓存的静态资源
const STATIC_ASSETS = [
  '/',
  '/offline',
  '/manifest.json',
  '/images/logo.svg',
  '/images/icons/icon-192x192.png',
  '/images/icons/icon-512x512.png',
];

// 安装Service Worker
self.addEventListener('install', event => {
  event.waitUntil(
    caches.open(STATIC_CACHE).then(cache => {
      return cache.addAll(STATIC_ASSETS);
    })
  );
  self.skipWaiting();
});

// 激活Service Worker
self.addEventListener('activate', event => {
  event.waitUntil(
    caches.keys().then(keys => {
      return Promise.all(
        keys.map(key => {
          if (key !== CACHE_NAME && key !== STATIC_CACHE && key !== DYNAMIC_CACHE) {
            return caches.delete(key);
          }
        })
      );
    })
  );
  self.clients.claim();
});

// 拦截网络请求
self.addEventListener('fetch', event => {
  const { request } = event;
  const url = new URL(request.url);

  // 忽略非GET请求
  if (request.method !== 'GET') return;

  // 忽略chrome-extension请求
  if (url.protocol === 'chrome-extension:') return;

  // API请求策略：网络优先
  if (url.pathname.startsWith('/api/')) {
    event.respondWith(
      fetch(request)
        .then(response => {
          // 缓存成功的API响应
          if (response.status === 200) {
            const responseClone = response.clone();
            caches.open(DYNAMIC_CACHE).then(cache => {
              cache.put(request, responseClone);
            });
          }
          return response;
        })
        .catch(() => {
          // 网络失败时返回缓存
          return caches.match(request);
        })
    );
    return;
  }

  // 静态资源策略：缓存优先
  if (request.destination === 'image' || 
      request.destination === 'script' || 
      request.destination === 'style') {
    event.respondWith(
      caches.match(request).then(cachedResponse => {
        if (cachedResponse) {
          return cachedResponse;
        }
        
        return fetch(request).then(response => {
          const responseClone = response.clone();
          caches.open(STATIC_CACHE).then(cache => {
            cache.put(request, responseClone);
          });
          return response;
        });
      })
    );
    return;
  }

  // HTML页面策略：网络优先，缓存回退
  event.respondWith(
    fetch(request)
      .then(response => {
        const responseClone = response.clone();
        caches.open(DYNAMIC_CACHE).then(cache => {
          cache.put(request, responseClone);
        });
        return response;
      })
      .catch(() => {
        return caches.match(request).then(cachedResponse => {
          return cachedResponse || caches.match('/offline');
        });
      })
  );
});
```

### React Query缓存配置
```typescript
// src/lib/query/query-client.ts
import { QueryClient } from '@tanstack/react-query';
import { persistQueryClient } from '@tanstack/react-query-persist-client-core';
import { createSyncStoragePersister } from '@tanstack/query-sync-storage-persister';

// 创建持久化存储
const persister = createSyncStoragePersister({
  storage: typeof window !== 'undefined' ? window.localStorage : undefined,
  key: 'LITONG_QUERY_CACHE',
  serialize: JSON.stringify,
  deserialize: JSON.parse,
});

export const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      // 缓存时间：5分钟
      staleTime: 5 * 60 * 1000,
      // 数据保留时间：30分钟
      gcTime: 30 * 60 * 1000,
      // 重试配置
      retry: (failureCount, error: any) => {
        // 4xx错误不重试
        if (error?.status >= 400 && error?.status < 500) {
          return false;
        }
        // 最多重试2次
        return failureCount < 2;
      },
      retryDelay: attemptIndex => Math.min(1000 * 2 ** attemptIndex, 30000),
      // 网络重连时重新获取
      refetchOnReconnect: true,
      // 窗口聚焦时重新获取
      refetchOnWindowFocus: false,
    },
    mutations: {
      retry: 1,
    },
  },
});

// 持久化查询客户端
if (typeof window !== 'undefined') {
  persistQueryClient({
    queryClient,
    persister,
    maxAge: 24 * 60 * 60 * 1000, // 24小时
  });
}

// 预取关键数据
export function prefetchCriticalData() {
  // 预取品牌数据
  queryClient.prefetchQuery({
    queryKey: ['brands'],
    queryFn: () => fetch('/api/brands').then(res => res.json()),
    staleTime: 10 * 60 * 1000, // 10分钟
  });

  // 预取产品分类
  queryClient.prefetchQuery({
    queryKey: ['categories'],
    queryFn: () => fetch('/api/categories').then(res => res.json()),
    staleTime: 30 * 60 * 1000, // 30分钟
  });
}

// 查询键工厂
export const queryKeys = {
  all: ['litong'] as const,
  
  brands: () => [...queryKeys.all, 'brands'] as const,
  brand: (slug: string) => [...queryKeys.brands(), slug] as const,
  
  products: () => [...queryKeys.all, 'products'] as const,
  product: (slug: string) => [...queryKeys.products(), slug] as const,
  productsByCategory: (category: string) => [...queryKeys.products(), 'category', category] as const,
  productsByBrand: (brand: string) => [...queryKeys.products(), 'brand', brand] as const,
  
  search: (query: string, filters?: any) => [...queryKeys.all, 'search', query, filters] as const,
  
  articles: () => [...queryKeys.all, 'articles'] as const,
  article: (slug: string) => [...queryKeys.articles(), slug] as const,
  
  solutions: () => [...queryKeys.all, 'solutions'] as const,
  solution: (slug: string) => [...queryKeys.solutions(), slug] as const,
};
```

## 图片优化策略

### 响应式图片实现
```typescript
// src/lib/image/responsive-images.ts
interface ImageBreakpoint {
  width: number;
  quality?: number;
  format?: 'webp' | 'avif' | 'jpeg' | 'png';
}

interface ResponsiveImageConfig {
  src: string;
  alt: string;
  breakpoints: ImageBreakpoint[];
  sizes: string;
  priority?: boolean;
  placeholder?: 'blur' | 'empty';
}

export function generateResponsiveImageProps(config: ResponsiveImageConfig) {
  const { src, alt, breakpoints, sizes, priority = false, placeholder = 'blur' } = config;

  // 生成srcSet
  const srcSet = breakpoints
    .map(bp => {
      const url = new URL('/api/images/optimize', window.location.origin);
      url.searchParams.set('src', src);
      url.searchParams.set('w', bp.width.toString());
      url.searchParams.set('q', (bp.quality || 85).toString());
      url.searchParams.set('f', bp.format || 'webp');
      
      return `${url.toString()} ${bp.width}w`;
    })
    .join(', ');

  // 生成默认src（使用最大尺寸）
  const defaultBreakpoint = breakpoints[breakpoints.length - 1];
  const defaultUrl = new URL('/api/images/optimize', window.location.origin);
  defaultUrl.searchParams.set('src', src);
  defaultUrl.searchParams.set('w', defaultBreakpoint.width.toString());
  defaultUrl.searchParams.set('q', (defaultBreakpoint.quality || 85).toString());

  // 生成占位符
  const blurDataURL = placeholder === 'blur' ? generateBlurPlaceholder(src) : undefined;

  return {
    src: defaultUrl.toString(),
    srcSet,
    sizes,
    alt,
    priority,
    placeholder,
    blurDataURL,
  };
}

function generateBlurPlaceholder(src: string): string {
  const blurUrl = new URL('/api/images/optimize', window.location.origin);
  blurUrl.searchParams.set('src', src);
  blurUrl.searchParams.set('w', '20');
  blurUrl.searchParams.set('q', '20');
  blurUrl.searchParams.set('blur', '10');
  
  return blurUrl.toString();
}

// 使用示例
export function ProductImage({ product }: { product: Product }) {
  const imageConfig: ResponsiveImageConfig = {
    src: product.image.url,
    alt: `${product.name} 产品图片`,
    breakpoints: [
      { width: 400, quality: 75, format: 'webp' },
      { width: 800, quality: 80, format: 'webp' },
      { width: 1200, quality: 85, format: 'webp' },
    ],
    sizes: '(max-width: 768px) 100vw, (max-width: 1200px) 50vw, 33vw',
    priority: false,
  };

  const imageProps = generateResponsiveImageProps(imageConfig);

  return (
    <img
      {...imageProps}
      className="w-full h-auto object-cover rounded-lg"
    />
  );
}
```

### 图片CDN优化API
```typescript
// src/pages/api/images/optimize.ts
import type { NextApiRequest, NextApiResponse } from 'next';
import sharp from 'sharp';

interface ImageOptimizeQuery {
  src: string;
  w?: string;  // width
  h?: string;  // height
  q?: string;  // quality
  f?: string;  // format
  blur?: string;
}

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse
) {
  const { src, w, h, q, f, blur } = req.query as ImageOptimizeQuery;

  if (!src) {
    return res.status(400).json({ error: 'Missing src parameter' });
  }

  try {
    // 获取原始图片
    const imageResponse = await fetch(src);
    if (!imageResponse.ok) {
      throw new Error(`Failed to fetch image: ${imageResponse.statusText}`);
    }

    const imageBuffer = Buffer.from(await imageResponse.arrayBuffer());

    // 使用Sharp处理图片
    let image = sharp(imageBuffer);

    // 调整尺寸
    if (w || h) {
      image = image.resize({
        width: w ? parseInt(w) : undefined,
        height: h ? parseInt(h) : undefined,
        fit: 'cover',
        position: 'center',
      });
    }

    // 应用模糊效果
    if (blur) {
      image = image.blur(parseInt(blur));
    }

    // 设置质量和格式
    const quality = q ? parseInt(q) : 85;
    const format = f as 'webp' | 'avif' | 'jpeg' | 'png' || 'webp';

    let outputBuffer: Buffer;
    let contentType: string;

    switch (format) {
      case 'avif':
        outputBuffer = await image.avif({ quality }).toBuffer();
        contentType = 'image/avif';
        break;
      case 'webp':
        outputBuffer = await image.webp({ quality }).toBuffer();
        contentType = 'image/webp';
        break;
      case 'jpeg':
        outputBuffer = await image.jpeg({ quality }).toBuffer();
        contentType = 'image/jpeg';
        break;
      case 'png':
        outputBuffer = await image.png({ quality }).toBuffer();
        contentType = 'image/png';
        break;
      default:
        outputBuffer = await image.webp({ quality }).toBuffer();
        contentType = 'image/webp';
    }

    // 设置缓存头
    res.setHeader('Content-Type', contentType);
    res.setHeader('Cache-Control', 'public, max-age=31536000, immutable');
    res.setHeader('Content-Length', outputBuffer.length);

    res.status(200).send(outputBuffer);
  } catch (error) {
    console.error('Image optimization error:', error);
    res.status(500).json({ error: 'Image optimization failed' });
  }
}

export const config = {
  api: {
    responseLimit: '10mb',
  },
};
```

## 监控和测量

### 性能监控实现
```typescript
// src/lib/analytics/performance-monitor.ts
interface PerformanceMetric {
  name: string;
  value: number;
  rating: 'good' | 'needs-improvement' | 'poor';
  timestamp: number;
  url: string;
  userAgent: string;
}

class PerformanceMonitor {
  private metrics: PerformanceMetric[] = [];
  private observer: PerformanceObserver | null = null;

  constructor() {
    if (typeof window !== 'undefined') {
      this.initialize();
    }
  }

  private initialize() {
    // 监控Core Web Vitals
    this.observeWebVitals();
    
    // 监控资源加载时间
    this.observeResourceTiming();
    
    // 监控长任务
    this.observeLongTasks();
  }

  private observeWebVitals() {
    // LCP监控
    this.createObserver('largest-contentful-paint', (entry: any) => {
      this.recordMetric({
        name: 'LCP',
        value: entry.startTime,
        rating: entry.startTime <= 2500 ? 'good' : entry.startTime <= 4000 ? 'needs-improvement' : 'poor'
      });
    });

    // FID监控
    this.createObserver('first-input', (entry: any) => {
      this.recordMetric({
        name: 'FID',
        value: entry.processingStart - entry.startTime,
        rating: entry.processingStart - entry.startTime <= 100 ? 'good' : 
                entry.processingStart - entry.startTime <= 300 ? 'needs-improvement' : 'poor'
      });
    });

    // CLS监控
    let clsValue = 0;
    this.createObserver('layout-shift', (entry: any) => {
      if (!entry.hadRecentInput) {
        clsValue += entry.value;
        
        // 延迟记录CLS以获取累积值
        setTimeout(() => {
          this.recordMetric({
            name: 'CLS',
            value: clsValue,
            rating: clsValue <= 0.1 ? 'good' : clsValue <= 0.25 ? 'needs-improvement' : 'poor'
          });
        }, 100);
      }
    });

    // FCP监控
    this.createObserver('paint', (entry: any) => {
      if (entry.name === 'first-contentful-paint') {
        this.recordMetric({
          name: 'FCP',
          value: entry.startTime,
          rating: entry.startTime <= 1800 ? 'good' : entry.startTime <= 3000 ? 'needs-improvement' : 'poor'
        });
      }
    });

    // TTFB监控
    const navigation = performance.getEntriesByType('navigation')[0] as PerformanceNavigationTiming;
    if (navigation) {
      const ttfb = navigation.responseStart - navigation.fetchStart;
      this.recordMetric({
        name: 'TTFB',
        value: ttfb,
        rating: ttfb <= 600 ? 'good' : ttfb <= 1500 ? 'needs-improvement' : 'poor'
      });
    }
  }

  private observeResourceTiming() {
    this.createObserver('resource', (entry: any) => {
      // 监控关键资源加载时间
      const duration = entry.responseEnd - entry.startTime;
      const resourceType = entry.initiatorType;
      
      if (['script', 'stylesheet', 'fetch', 'xmlhttprequest'].includes(resourceType)) {
        this.recordMetric({
          name: `Resource-${resourceType}`,
          value: duration,
          rating: duration <= 1000 ? 'good' : duration <= 3000 ? 'needs-improvement' : 'poor'
        });
      }
    });
  }

  private observeLongTasks() {
    this.createObserver('longtask', (entry: any) => {
      this.recordMetric({
        name: 'Long-Task',
        value: entry.duration,
        rating: entry.duration <= 50 ? 'good' : entry.duration <= 100 ? 'needs-improvement' : 'poor'
      });
    });
  }

  private createObserver(entryType: string, callback: (entry: any) => void) {
    try {
      const observer = new PerformanceObserver((list) => {
        list.getEntries().forEach(callback);
      });
      observer.observe({ entryTypes: [entryType] });
    } catch (error) {
      console.warn(`Performance observer for ${entryType} not supported:`, error);
    }
  }

  private recordMetric(metric: Omit<PerformanceMetric, 'timestamp' | 'url' | 'userAgent'>) {
    const fullMetric: PerformanceMetric = {
      ...metric,
      timestamp: Date.now(),
      url: window.location.href,
      userAgent: navigator.userAgent,
    };

    this.metrics.push(fullMetric);

    // 发送到分析服务
    this.sendMetricToAnalytics(fullMetric);
  }

  private async sendMetricToAnalytics(metric: PerformanceMetric) {
    try {
      // 发送到Google Analytics
      if (typeof gtag !== 'undefined') {
        gtag('event', metric.name, {
          event_category: 'Web Vitals',
          value: Math.round(metric.value),
          event_label: metric.rating,
          non_interaction: true,
        });
      }

      // 发送到自定义分析端点
      await fetch('/api/analytics/performance', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(metric),
      });
    } catch (error) {
      console.warn('Failed to send performance metric:', error);
    }
  }

  public getMetrics() {
    return this.metrics;
  }

  public getMetricsByName(name: string) {
    return this.metrics.filter(metric => metric.name === name);
  }

  public getAverageMetric(name: string) {
    const metrics = this.getMetricsByName(name);
    if (metrics.length === 0) return 0;
    
    const sum = metrics.reduce((acc, metric) => acc + metric.value, 0);
    return sum / metrics.length;
  }
}

export const performanceMonitor = new PerformanceMonitor();

// 在应用启动时初始化
export function initializePerformanceMonitoring() {
  if (typeof window !== 'undefined') {
    // Web Vitals库的集成
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(console.log);
      getFID(console.log);
      getFCP(console.log);
      getLCP(console.log);
      getTTFB(console.log);
    });
  }
}
```