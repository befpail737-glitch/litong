# 部署运维方案

## Cloudflare Pages部署配置

### 项目部署设置
```yaml
# 部署配置概览
Platform: Cloudflare Pages
Repository: https://github.com/befpail737-glitch/litong.git
Production Branch: main
Preview Branch: develop
Build Command: npm run build
Output Directory: .next
Node.js Version: 18.x
```

### 构建配置文件
```toml
# wrangler.toml
name = "litong-electronics"
compatibility_date = "2024-01-01"

[build]
command = "npm run build"
cwd = "."
watch_dir = "src"

[build.upload]
format = "modules"

[[build.upload.rules]]
type = "ESModule"
globs = ["**/*.js"]

[vars]
NODE_ENV = "production"
NEXT_PUBLIC_SITE_URL = "https://www.elec-distributor.com"

[env.production]
NEXT_PUBLIC_SANITY_PROJECT_ID = "oquvb2bs"
NEXT_PUBLIC_SANITY_DATASET = "production"

[env.preview]
NEXT_PUBLIC_SANITY_PROJECT_ID = "oquvb2bs"
NEXT_PUBLIC_SANITY_DATASET = "preview"
```

### package.json构建脚本
```json
{
  "scripts": {
    "dev": "next dev",
    "build": "next build",
    "start": "next start",
    "lint": "next lint",
    "type-check": "tsc --noEmit",
    "build:analyze": "ANALYZE=true npm run build",
    "build:production": "NODE_ENV=production next build",
    "export": "next export",
    "deploy:preview": "wrangler pages publish .next --project-name litong-preview",
    "deploy:production": "wrangler pages publish .next --project-name litong-production"
  }
}
```

## GitHub Actions CI/CD流程

### 自动化部署工作流
```yaml
# .github/workflows/deploy.yml
name: Deploy to Cloudflare Pages

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main

jobs:
  # 代码质量检查
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run ESLint
        run: npm run lint
        
      - name: Run TypeScript check
        run: npm run type-check
        
      - name: Run tests
        run: npm test -- --coverage --watchAll=false
        
      - name: Upload coverage reports
        uses: codecov/codecov-action@v3
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  # 构建和部署
  build-and-deploy:
    needs: quality-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Build application
        run: npm run build
        env:
          NEXT_PUBLIC_SANITY_PROJECT_ID: ${{ secrets.SANITY_PROJECT_ID }}
          NEXT_PUBLIC_SANITY_DATASET: ${{ github.ref == 'refs/heads/main' && 'production' || 'preview' }}
          SANITY_API_TOKEN: ${{ secrets.SANITY_API_TOKEN }}
          NEXT_PUBLIC_SITE_URL: ${{ github.ref == 'refs/heads/main' && 'https://www.elec-distributor.com' || 'https://preview.elec-distributor.com' }}
          
      - name: Deploy to Cloudflare Pages
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: litong-electronics
          directory: .next
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}
          
  # 部署后测试
  post-deploy-tests:
    needs: build-and-deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Run E2E tests
        run: npm run test:e2e
        env:
          BASE_URL: https://www.elec-distributor.com
          
      - name: Run Lighthouse audit
        uses: treosh/lighthouse-ci-action@v10
        with:
          urls: |
            https://www.elec-distributor.com
            https://www.elec-distributor.com/brands
            https://www.elec-distributor.com/products
          configPath: './lighthouse.config.js'
          uploadArtifacts: true
          
      - name: Notify deployment status
        uses: 8398a7/action-slack@v3
        if: always()
        with:
          status: ${{ job.status }}
          channel: '#deployments'
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
```

### 分支策略和环境管理
```yaml
# 环境配置策略
environments:
  production:
    branch: main
    url: https://www.elec-distributor.com
    sanity_dataset: production
    analytics: enabled
    
  preview:
    branch: develop
    url: https://preview.elec-distributor.com
    sanity_dataset: preview
    analytics: disabled
    
  feature:
    branch: feature/*
    url: https://{branch-name}.elec-distributor.pages.dev
    sanity_dataset: preview
    analytics: disabled
```

## 环境变量管理

### 生产环境变量
```bash
# Cloudflare Pages环境变量配置
# 基础配置
NODE_ENV=production
NEXT_PUBLIC_SITE_URL=https://www.elec-distributor.com
NEXT_PUBLIC_SITE_NAME=力通电子

# Sanity CMS配置
NEXT_PUBLIC_SANITY_PROJECT_ID=oquvb2bs
NEXT_PUBLIC_SANITY_DATASET=production
SANITY_API_TOKEN=skcH3gNsf...（生产环境Token）
SANITY_PREVIEW_SECRET=your-preview-secret

# 分析工具
NEXT_PUBLIC_GA_ID=G-XXXXXXXXXX
NEXT_PUBLIC_GTAG_ID=GT-XXXXXXXXX
NEXT_PUBLIC_HOTJAR_ID=your-hotjar-id

# 邮件服务
SMTP_HOST=smtp.gmail.com
SMTP_PORT=587
SMTP_USER=noreply@elec-distributor.com
SMTP_PASS=your-app-password

# 安全配置
RECAPTCHA_SECRET_KEY=your-recaptcha-secret
NEXT_PUBLIC_RECAPTCHA_SITE_KEY=your-recaptcha-site-key

# 第三方服务
ALGOLIA_APP_ID=your-algolia-app-id
ALGOLIA_API_KEY=your-algolia-api-key
ALGOLIA_SEARCH_KEY=your-algolia-search-key

# CDN配置
NEXT_PUBLIC_CDN_URL=https://cdn.elec-distributor.com
```

### 开发环境配置
```bash
# .env.local (开发环境)
NODE_ENV=development
NEXT_PUBLIC_SITE_URL=http://localhost:3000
NEXT_PUBLIC_SITE_NAME=力通电子 (开发)

# Sanity CMS配置
NEXT_PUBLIC_SANITY_PROJECT_ID=oquvb2bs
NEXT_PUBLIC_SANITY_DATASET=development
SANITY_API_TOKEN=skcH3gNsf...（开发环境Token）

# 开发工具
ANALYZE=false
NEXT_PUBLIC_SHOW_DEBUG=true
```

## 性能监控配置

### Lighthouse配置
```javascript
// lighthouse.config.js
module.exports = {
  ci: {
    collect: {
      numberOfRuns: 3,
      startServerCommand: 'npm start',
      startServerReadyPattern: 'ready on',
      url: [
        'http://localhost:3000',
        'http://localhost:3000/brands',
        'http://localhost:3000/products',
        'http://localhost:3000/about',
      ],
      settings: {
        chromeFlags: '--no-sandbox --headless',
      },
    },
    assert: {
      assertions: {
        'categories:performance': ['error', { minScore: 0.8 }],
        'categories:accessibility': ['error', { minScore: 0.9 }],
        'categories:best-practices': ['error', { minScore: 0.9 }],
        'categories:seo': ['error', { minScore: 0.9 }],
      },
    },
    upload: {
      target: 'lhci',
      serverBaseUrl: 'https://lighthouse.elec-distributor.com',
      token: process.env.LHCI_TOKEN,
    },
  },
};
```

### 性能监控脚本
```typescript
// src/lib/analytics/performance.ts
export function initPerformanceMonitoring() {
  // Core Web Vitals监控
  if (typeof window !== 'undefined') {
    import('web-vitals').then(({ getCLS, getFID, getFCP, getLCP, getTTFB }) => {
      getCLS(sendToAnalytics);
      getFID(sendToAnalytics);
      getFCP(sendToAnalytics);
      getLCP(sendToAnalytics);
      getTTFB(sendToAnalytics);
    });
  }
}

function sendToAnalytics(metric: any) {
  // 发送到Google Analytics
  if (typeof gtag !== 'undefined') {
    gtag('event', metric.name, {
      event_category: 'Web Vitals',
      value: Math.round(metric.name === 'CLS' ? metric.value * 1000 : metric.value),
      event_label: metric.id,
      non_interaction: true,
    });
  }
  
  // 发送到自定义分析端点
  fetch('/api/analytics/vitals', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      name: metric.name,
      value: metric.value,
      id: metric.id,
      url: window.location.href,
      timestamp: Date.now(),
    }),
  }).catch(console.error);
}
```

## 域名和SSL配置

### 域名配置策略
```yaml
# 域名配置
primary_domain: www.elec-distributor.com
redirect_domains:
  - elec-distributor.com → www.elec-distributor.com
  - litong.com → www.elec-distributor.com
  
subdomain_structure:
  - www: 主站
  - admin: Sanity CMS (admin.elec-distributor.com)
  - api: API服务 (api.elec-distributor.com)
  - cdn: 静态资源CDN (cdn.elec-distributor.com)
  - preview: 预览环境 (preview.elec-distributor.com)
```

### SSL证书自动管理
```javascript
// Cloudflare SSL配置
const sslConfig = {
  // SSL/TLS加密模式
  ssl_mode: 'strict', // Full (strict)
  
  // 自动HTTPS重写
  auto_https_rewrites: true,
  
  // HSTS设置
  security_headers: {
    strict_transport_security: {
      enabled: true,
      max_age: 31536000,
      include_subdomains: true,
      preload: true
    }
  },
  
  // 证书透明度
  certificate_transparency_monitoring: true,
  
  // 最小TLS版本
  min_tls_version: '1.2'
};
```

## 缓存策略配置

### Cloudflare缓存规则
```javascript
// 缓存配置规则
const cacheRules = {
  // 静态资源 - 长期缓存
  static_assets: {
    pattern: '*.{css,js,png,jpg,jpeg,gif,svg,woff,woff2,ttf,eot,ico}',
    cache_level: 'cache_everything',
    browser_ttl: 31536000, // 1年
    edge_ttl: 31536000,    // 1年
    always_online: true
  },
  
  // HTML页面 - 短期缓存
  html_pages: {
    pattern: '*.html',
    cache_level: 'cache_everything',
    browser_ttl: 3600,     // 1小时
    edge_ttl: 14400,       // 4小时
    always_online: true
  },
  
  // API路由 - 不缓存
  api_routes: {
    pattern: '/api/*',
    cache_level: 'bypass',
    browser_ttl: 0,
    edge_ttl: 0
  },
  
  // 动态内容 - 智能缓存
  dynamic_content: {
    pattern: '/products/*',
    cache_level: 'cache_everything',
    browser_ttl: 1800,     // 30分钟
    edge_ttl: 7200,        // 2小时
    cache_key: {
      include_query_string: true,
      ignore_query_strings: ['utm_*', 'fbclid']
    }
  }
};
```

### Next.js ISR配置
```typescript
// 增量静态再生成配置
export const revalidateConfig = {
  // 首页 - 1小时重新验证
  homepage: {
    revalidate: 3600,
    fallback: 'blocking'
  },
  
  // 产品页面 - 30分钟重新验证
  products: {
    revalidate: 1800,
    fallback: true
  },
  
  // 品牌页面 - 2小时重新验证
  brands: {
    revalidate: 7200,
    fallback: true
  },
  
  // 技术文章 - 4小时重新验证
  articles: {
    revalidate: 14400,
    fallback: true
  }
};
```

## 监控和告警系统

### 健康检查配置
```typescript
// src/pages/api/health.ts
import type { NextApiRequest, NextApiResponse } from 'next';
import { client } from '@/lib/sanity/client';

interface HealthCheck {
  status: 'healthy' | 'degraded' | 'unhealthy';
  timestamp: string;
  services: {
    database: boolean;
    cms: boolean;
    external_apis: boolean;
  };
  response_time: number;
}

export default async function handler(
  req: NextApiRequest,
  res: NextApiResponse<HealthCheck>
) {
  const startTime = Date.now();
  
  // 检查各个服务状态
  const checks = await Promise.allSettled([
    checkCMS(),
    checkExternalAPIs(),
  ]);
  
  const services = {
    database: true, // Static site, no database
    cms: checks[0].status === 'fulfilled' && checks[0].value,
    external_apis: checks[1].status === 'fulfilled' && checks[1].value,
  };
  
  const allHealthy = Object.values(services).every(Boolean);
  const responseTime = Date.now() - startTime;
  
  const healthCheck: HealthCheck = {
    status: allHealthy ? 'healthy' : 'degraded',
    timestamp: new Date().toISOString(),
    services,
    response_time: responseTime,
  };
  
  const statusCode = allHealthy ? 200 : 503;
  res.status(statusCode).json(healthCheck);
}

async function checkCMS(): Promise<boolean> {
  try {
    await client.fetch('*[_type == "brand"][0]');
    return true;
  } catch (error) {
    console.error('CMS health check failed:', error);
    return false;
  }
}

async function checkExternalAPIs(): Promise<boolean> {
  // 检查外部API服务
  return true;
}
```

### 错误监控配置
```typescript
// src/lib/monitoring/sentry.ts
import * as Sentry from '@sentry/nextjs';

Sentry.init({
  dsn: process.env.NEXT_PUBLIC_SENTRY_DSN,
  environment: process.env.NODE_ENV,
  
  // 性能监控
  tracesSampleRate: 1.0,
  
  // 错误过滤
  beforeSend(event, hint) {
    // 过滤掉开发环境错误
    if (process.env.NODE_ENV === 'development') {
      return null;
    }
    
    // 过滤掉已知的第三方错误
    if (event.exception?.values?.[0]?.value?.includes('Non-Error promise rejection')) {
      return null;
    }
    
    return event;
  },
  
  // 集成配置
  integrations: [
    new Sentry.BrowserTracing({
      tracingOrigins: ['localhost', 'elec-distributor.com'],
    }),
  ],
});
```

### 日志聚合配置
```typescript
// src/lib/logging/logger.ts
interface LogEntry {
  level: 'info' | 'warn' | 'error';
  message: string;
  timestamp: string;
  metadata?: Record<string, any>;
  userId?: string;
  sessionId?: string;
}

class Logger {
  private isDevelopment = process.env.NODE_ENV === 'development';
  
  private log(entry: LogEntry) {
    if (this.isDevelopment) {
      console.log(`[${entry.level.toUpperCase()}] ${entry.message}`, entry.metadata);
      return;
    }
    
    // 生产环境发送到日志服务
    this.sendToLogService(entry);
  }
  
  private async sendToLogService(entry: LogEntry) {
    try {
      await fetch('/api/logs', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(entry),
      });
    } catch (error) {
      console.error('Failed to send log:', error);
    }
  }
  
  info(message: string, metadata?: Record<string, any>) {
    this.log({
      level: 'info',
      message,
      timestamp: new Date().toISOString(),
      metadata,
    });
  }
  
  warn(message: string, metadata?: Record<string, any>) {
    this.log({
      level: 'warn',
      message,
      timestamp: new Date().toISOString(),
      metadata,
    });
  }
  
  error(message: string, error?: Error, metadata?: Record<string, any>) {
    this.log({
      level: 'error',
      message,
      timestamp: new Date().toISOString(),
      metadata: {
        ...metadata,
        error: error?.message,
        stack: error?.stack,
      },
    });
  }
}

export const logger = new Logger();
```

## 备份和恢复策略

### 数据备份配置
```yaml
# Sanity数据备份策略
backup_schedule:
  - frequency: daily
    time: "02:00"
    retention: 30 days
    
  - frequency: weekly  
    time: "Sunday 03:00"
    retention: 12 weeks
    
  - frequency: monthly
    time: "1st Sunday 04:00"
    retention: 12 months

backup_types:
  - full_export: 包含所有文档和资源
  - incremental: 仅包含变更内容
  - schema_only: 仅包含数据结构
```

### 灾难恢复计划
```typescript
// 恢复脚本示例
// scripts/disaster-recovery.ts
import { client } from '@/lib/sanity/client';

interface RecoveryPlan {
  priority: 'critical' | 'high' | 'medium' | 'low';
  estimated_rto: string; // Recovery Time Objective
  estimated_rpo: string; // Recovery Point Objective
  steps: string[];
}

const recoveryProcedures: Record<string, RecoveryPlan> = {
  'cms_failure': {
    priority: 'critical',
    estimated_rto: '2 hours',
    estimated_rpo: '1 hour',
    steps: [
      '1. 验证Sanity服务状态',
      '2. 检查API密钥有效性',
      '3. 从最近备份恢复数据',
      '4. 重新部署应用程序',
      '5. 验证功能完整性',
    ]
  },
  
  'site_down': {
    priority: 'critical',
    estimated_rto: '30 minutes',
    estimated_rpo: '0',
    steps: [
      '1. 检查Cloudflare Pages状态',
      '2. 验证DNS解析',
      '3. 检查SSL证书',
      '4. 回滚到上一个稳定版本',
      '5. 通知相关团队',
    ]
  },
  
  'performance_degradation': {
    priority: 'high',
    estimated_rto: '1 hour',
    estimated_rpo: '0',
    steps: [
      '1. 分析性能监控数据',
      '2. 识别性能瓶颈',
      '3. 调整缓存策略',
      '4. 优化数据库查询',
      '5. 监控改进效果',
    ]
  }
};
```